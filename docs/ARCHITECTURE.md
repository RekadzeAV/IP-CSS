# Архитектура кроссплатформенной системы видеонаблюдения

**Дата обновления:** Январь 2025
**Версия проекта:** 3.0.0

## Обзор архитектуры

Система построена по принципу многослойной Clean Architecture с использованием Kotlin Multiplatform для кроссплатформенной бизнес-логики и нативных UI фреймворков для каждой платформы.

**Важное изменение:** Проект реорганизован по платформам. Каждая платформа имеет свою директорию в `platforms/` с подробной документацией. См. [PLATFORM_STRUCTURE.md](../../PLATFORM_STRUCTURE.md) и [PLATFORMS.md](PLATFORMS.md) для подробностей.

## Структура платформ

Проект разделен на следующие платформы:

### Серверные платформы с веб-интерфейсом

1. **Микрокомпьютеры ARM** (`platforms/sbc-arm/`)
   - Raspberry Pi, Orange Pi, Rock64 и др.
   - Веб-интерфейс для управления
   
2. **Серверы x86-x64** (`platforms/server-x86_64/`)
   - Linux, Windows, macOS серверы
   - Веб-интерфейс для управления
   
3. **NAS ARM** (`platforms/nas-arm/`)
   - Synology, QNAP, Asustor (ARM модели)
   - Веб-интерфейс для управления
   
4. **NAS x86-x64** (`platforms/nas-x86_64/`)
   - Synology, QNAP, Asustor, TrueNAS (x86_64 модели)
   - Веб-интерфейс для управления

### Клиентские платформы

5. **Клиенты Desktop x86-x64** (`platforms/client-desktop-x86_64/`)
   - Windows, Linux, macOS (Intel)
   - Нативное приложение (Compose Desktop)
   
6. **Клиенты Desktop ARM** (`platforms/client-desktop-arm/`)
   - Linux ARM64, macOS Apple Silicon
   - Нативное приложение (Compose Desktop)
   
7. **Клиенты Android** (`platforms/client-android/`)
   - Мобильные устройства Android
   - Нативное приложение (Jetpack Compose)
   
8. **Клиенты iOS/macOS** (`platforms/client-ios/`)
   - iOS и macOS устройства
   - Нативное приложение (SwiftUI)

Все серверные платформы используют общие модули:
- `:server:api` - REST API сервер (Ktor)
- `server/web` - Веб-интерфейс (Next.js)

Все платформы используют общие модули:
- `:shared` - Kotlin Multiplatform модуль с общей бизнес-логикой
- `:core:common`, `:core:network`, `:core:license` - общие модули
- `native/` - нативные C++ библиотеки

## Архитектурные принципы

1. **Принцип единой ответственности** - каждый модуль отвечает за одну конкретную задачу
2. **Разделение ответственности** - четкое разделение на слои: данные, домен, представление
3. **Инверсия зависимостей** - зависимости направлены к абстракциям, а не к реализациям
4. **Принцип подстановки Барбары Лисков** - объекты могут быть заменены их подтипами
5. **Принцип открытости/закрытости** - открыты для расширения, закрыты для модификации

## Слои архитектуры

### 1. Слой данных (Data Layer)

**Ответственность**: Работа с источниками данных (локальными, сетевыми, облачными)

**Компоненты**:
- **Репозитории** - абстракции для доступа к данным
- **Data Sources** - конкретные реализации источников данных
  - Локальная БД (SQLite с SQLDelight)
  - Файловая система (видеоархивы, конфигурации)
  - Сетевые API (лицензионный сервер, облачные сервисы)
  - IP-камеры (RTSP, ONVIF)

**Технологии**:
- Kotlin Multiplatform для общей логики
- SQLDelight для кроссплатформенной работы с SQLite
- Ktor Client для сетевых запросов

### 2. Доменный слой (Domain Layer)

**Ответственность**: Бизнес-логика и правила приложения

**Компоненты**:
- **Use Cases** - конкретные бизнес-сценарии
- **Модели** - бизнес-сущности (Камера, Событие, Лицензия)
- **Репозитории интерфейсы** - абстракции для слоя данных
- **Сервисы** - доменные сервисы (лицензирование, аналитика)

**Особенности**:
- Полностью на Kotlin Multiplatform
- Не зависит от фреймворков и платформ
- Содержит unit тесты для бизнес-логики

### 3. Слой представления (Presentation Layer)

**Ответственность**: Пользовательский интерфейс и взаимодействие

**Архитектурный паттерн**: MVI (Model-View-Intent) или MVVM

**Компоненты**:
- **View** - UI компоненты
- **ViewModel/Presenter** - управление состоянием UI
- **State** - иммутабельное состояние экрана
- **Intent/Action** - пользовательские действия

**Платформенно-специфичные реализации**:

#### Серверные платформы (Веб-интерфейс):
- **Frontend**: React + TypeScript
- **UI Framework**: Material-UI / Next.js
- **Состояние**: Redux Toolkit
- **API клиент**: Axios

#### Android:
- **UI Framework**: Jetpack Compose
- **DI**: Hilt
- **Навигация**: Compose Navigation
- **Фоновая работа**: WorkManager, ForegroundService

#### iOS:
- **UI Framework**: SwiftUI
- **DI**: Swinject
- **Навигация**: SwiftUI Navigation
- **Фоновая работа**: BackgroundTasks, BGTaskScheduler

#### Desktop (Windows, Linux, macOS):
- **UI Framework**: Compose Desktop
- **DI**: Koin
- **Навигация**: собственный роутер на Compose
- **Фоновая работа**: системные службы/демоны

### 4. Слой инфраструктуры (Infrastructure Layer)

**Ответственность**: Кроссплатформенные сервисы и утилиты

**Модули**:
- `:core:common` - общие типы и модели (Resolution, CameraStatus)
- `:core:network` - сетевое взаимодействие (Ktor Client)
- `:core:license` - система лицензирования
- `:native:video-processing` - обработка видео на C++/OpenCV
- `:native:analytics` - AI аналитика на C++/TensorFlow Lite

## Модульная структура

### Корневая структура проекта:
```
ip-camera-surveillance-system/
├── shared/          # Kotlin Multiplatform модуль
│ ├── src/
│ │ ├── commonMain/ # Общий код для всех платформ
│ │ ├── androidMain/ # Android-специфичные реализации
│ │ ├── iosMain/    # iOS-специфичные реализации
│ │ └── desktopMain/ # Desktop-специфичные реализации
│ └── build.gradle.kts
├── platforms/      # Платформо-специфичные реализации
│ ├── sbc-arm/
│ ├── server-x86_64/
│ ├── nas-arm/
│ ├── nas-x86_64/
│ ├── client-desktop-x86_64/
│ ├── client-desktop-arm/
│ ├── client-android/
│ └── client-ios/
├── android/        # Android приложение
├── server/         # Серверная часть
│ ├── api/         # REST API (Ktor)
│ └── web/         # Веб-интерфейс (Next.js)
├── native/        # Нативные C++ библиотеки
│ ├── video-processing/
│ ├── analytics/
│ └── codecs/
├── core/          # Общие кроссплатформенные модули
│ ├── common/      # Общие типы
│ ├── network/     # Сетевые клиенты
│ └── license/     # Система лицензирования
└── docs/          # Документация
```

### Зависимости между модулями:
```
Платформы (серверные и клиентские)
    ↓
shared (KMM)
    ↓     ↓
    ↓  core:network
    ↓     ↓
    ↓  core:common (базовые типы: Resolution, CameraStatus)
    ↓
core:license
    ↓
native (C++ библиотеки через FFI)
```

## Кроссплатформенная коммуникация

### 1. Общая бизнес-логика (KMM)
```kotlin
// shared/src/commonMain/kotlin/com/company/domain/
interface CameraRepository {
    suspend fun getCameras(): List<Camera>
    suspend fun addCamera(camera: Camera)
    suspend fun removeCamera(id: String)
}
```

### 2. Нативные библиотеки (C++)
```cmake
# Интеграция C++ библиотек через FFI (Foreign Function Interface)
native fun processVideoFrame(frame: ByteArray): ProcessedFrame
native fun detectObjects(frame: ByteArray): List<Detection>
native fun recognizeLicensePlate(image: ByteArray): String?
```

### 3. Сетевая синхронизация
- Протокол: HTTP/2 + Protocol Buffers
- Сервисы: Лицензионный сервер, синхронизация настроек, удаленное управление
- Безопасность: TLS 1.3, JWT токены, шифрование end-to-end

## Система лицензирования

Архитектура:
```
Клиент (любая платформа)
    ↓ (HTTPS + TLS)
Лицензионный сервер (микросервис)
    ↓
База лицензий (PostgreSQL)
    ↓
Система биллинга (интеграция)
```

Компоненты:
1. Клиентская библиотека (KMM) - проверка лицензии, офлайн-работа
2. Сервер лицензий (Ktor) - управление лицензиями, генерация кодов
3. Административный портал (веб-интерфейс) - управление клиентами, лицензиями
4. Система уведомлений - напоминания об истечении, обновления

Безопасность:
- Асимметричное шифрование (RSA-2048/ECC) для подписей
- Симметричное шифрование (AES-256-GCM) для данных
- Привязка к устройству через аппаратные ключи
- Регулярная проверка отозванных лицензий (CRL/OCSP)

## Масштабирование и отказоустойчивость

### Вертикальное масштабирование:
- Оптимизация под разные классы устройств
- Адаптивная обработка видео
- Динамическое распределение ресурсов

### Горизонтальное масштабирование (enterprise):
```
Клиенты → Load Balancer → [Сервер 1, Сервер 2, Сервер N]
                              ↓
                       Общее хранилище (SAN/NAS)
                              ↓
                       База данных (кластер)
```

### Стратегии отказоустойчивости:
1. Репликация данных - синхронная/асинхронная репликация БД
2. Кластеризация - активный-активный или активный-пассивный
3. Геораспределение - дата-центры в разных регионах
4. Автоматическое восстановление - health checks, auto-restart

## Мониторинг и логирование

### Централизованное логирование:
- Структурированные логи (JSON)
- Сбор логов со всех компонентов
- Анализ и алертинг (ELK stack, Grafana)

### Метрики производительности:
- Время отклика API
- Использование ресурсов (CPU, память, диск, сеть)
- Качество видео (FPS, задержки, потеря кадров)
- Статистика пользователей (активные сессии, операции)

### Health checks:
- Endpoint /health на всех сервисах
- Проверка зависимостей (БД, внешние сервисы)
- Детальная информация о состоянии

## Развертывание

### Контейнеризация:
- Мульти-архитектурные образы (amd64, arm64)
- Многоступенчатые сборки для уменьшения размера
- Health checks и graceful shutdown

### Оркестрация (Kubernetes):
- Deployment для каждого микросервиса
- Service discovery и load balancing
- Horizontal Pod Autoscaling
- Rolling updates с blue-green deployment

### Инфраструктура как код:
- Terraform для облачных ресурсов
- Ansible для конфигурации
- GitOps для непрерывного развертывания

## Разделение по платформам

Проект использует Kotlin Multiplatform для кроссплатформенной разработки. Подробная информация о разделении разработки по платформам доступна в [PLATFORMS.md](PLATFORMS.md) и [PLATFORM_STRUCTURE.md](../../PLATFORM_STRUCTURE.md).

### Основные принципы:
- **Общий код** (`commonMain`) - бизнес-логика, модели, use cases
- **Платформо-специфичный код** (`androidMain`, `iosMain`, `desktopMain`) - UI, системные API, платформенные сервисы
- **Нативные библиотеки** (C++) - обработка видео, AI аналитика

### Source Sets:
- `commonMain` - код, общий для всех платформ
- `androidMain` - Android-специфичные реализации
- `iosMain` - iOS-специфичные реализации (arm64, x86_64 для симулятора)
- `desktopMain` - Desktop-специфичные реализации (JVM для Windows, Linux, macOS)

## Структура веток Git

Проект использует структуру веток, где каждая платформа имеет свои ветки разработки и тестирования:

- `develop/platform-*` - ветки разработки для каждой платформы
- `test/platform-*` - ветки тестирования для каждой платформы

Подробнее см. [PLATFORM_STRUCTURE.md](../../PLATFORM_STRUCTURE.md).

## Безопасность

### Защита данных:
- Шифрование данных в покое (AES-256)
- Шифрование данных в движении (TLS 1.3)
- Безопасное хранение ключей (HSM, Keychain, Keystore)

### Контроль доступа:
- Ролевая модель (RBAC)
- Многофакторная аутентификация
- Сессионное управление
- Аудит доступа

### Соответствие стандартам:
- GDPR - защита персональных данных
- ISO 27001 - управление информационной безопасностью
- SOC 2 - безопасность, доступность, конфиденциальность

## Связанные документы

- [PLATFORM_STRUCTURE.md](../../PLATFORM_STRUCTURE.md) - Структура платформ и веток
- [PLATFORMS.md](PLATFORMS.md) - Разделение разработки по платформам
- [PROJECT_STRUCTURE.md](../../PROJECT_STRUCTURE.md) - Структура проекта
- [DEVELOPMENT.md](DEVELOPMENT.md) - Руководство по разработке
- [IMPLEMENTATION_STATUS.md](IMPLEMENTATION_STATUS.md) - Статус реализации

---

**Последнее обновление:** Январь 2025
