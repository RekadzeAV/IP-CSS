# Архитектура кроссплатформенной системы видеонаблюдения

## Обзор архитектуры

Система построена по принципу многослойной Clean Architecture с использованием Kotlin Multiplatform для кроссплатформенной бизнес-логики и нативных UI фреймворков для каждой платформы.

## Архитектурные принципы

1. **Принцип единой ответственности** - каждый модуль отвечает за одну конкретную задачу
2. **Разделение ответственности** - четкое разделение на слои: данные, домен, представление
3. **Инверсия зависимостей** - зависимости направлены к абстракциям, а не к реализациям
4. **Принцип подстановки Барбары Лисков** - объекты могут быть заменены их подтипами
5. **Принцип открытости/закрытости** - открыты для расширения, закрыты для модификации

## Слои архитектуры

### 1. Слой данных (Data Layer)

**Ответственность**: Работа с источниками данных (локальными, сетевыми, облачными)

**Компоненты**:
- **Репозитории** - абстракции для доступа к данным
- **Data Sources** - конкретные реализации источников данных
  - Локальная БД (SQLite с SQLCipher)
  - Файловая система (видеоархивы, конфигурации)
  - Сетевые API (лицензионный сервер, облачные сервисы)
  - IP-камеры (RTSP, ONVIF)

**Технологии**:
- Kotlin Multiplatform для общей логики
- SQLDelight для кроссплатформенной работы с SQLite
- Ktor Client для сетевых запросов
- Room (Android) и Core Data (iOS) для платформенно-специфичных оптимизаций

### 2. Доменный слой (Domain Layer)

**Ответственность**: Бизнес-логика и правила приложения

**Компоненты**:
- **Use Cases** - конкретные бизнес-сценарии
- **Модели** - бизнес-сущности (Камера, Событие, Лицензия)
- **Репозитории интерфейсы** - абстракции для слоя данных
- **Сервисы** - доменные сервисы (лицензирование, аналитика)

**Особенности**:
- Полностью на Kotlin Multiplatform
- Не зависит от фреймворков и платформ
- Содержит unit тесты для бизнес-логики

### 3. Слой представления (Presentation Layer)

**Ответственность**: Пользовательский интерфейс и взаимодействие

**Архитектурный паттерн**: MVI (Model-View-Intent) или MVVM

**Компоненты**:
- **View** - UI компоненты (Activity/Fragment, Composable, SwiftUI View)
- **ViewModel/Presenter** - управление состоянием UI
- **State** - иммутабельное состояние экрана
- **Intent/Action** - пользовательские действия

**Платформенно-специфичные реализации**:

#### Android:
- **UI Framework**: Jetpack Compose
- **DI**: Hilt
- **Навигация**: Compose Navigation
- **Фоновая работа**: WorkManager, ForegroundService

#### iOS:
- **UI Framework**: SwiftUI (новые экраны) + UIKit (унаследованные)
- **DI**: Swinject
- **Навигация**: SwiftUI Navigation
- **Фоновая работа**: BackgroundTasks, BGTaskScheduler

#### Desktop (Windows, Linux, macOS):
- **UI Framework**: Compose Desktop
- **DI**: Koin
- **Навигация**: собственный роутер на Compose
- **Фоновая работа**: системные службы/демоны

#### Веб-интерфейс (NAS/Сервер):
- **Frontend**: React + TypeScript
- **UI Framework**: Material-UI
- **Состояние**: Redux Toolkit
- **API клиент**: Axios

### 4. Слой инфраструктуры (Infrastructure Layer)

**Ответственность**: Кроссплатформенные сервисы и утилиты

**Модули**:
- `:core:network` - сетевое взаимодействие (Ktor Client)
- `:core:database` - работа с БД (SQLDelight)
- `:core:utils` - общие утилиты
- `:core:license` - система лицензирования
- `:native:video-processing` - обработка видео на C++/OpenCV
- `:native:analytics` - AI аналитика на C++/TensorFlow Lite

## Модульная структура

### Корневая структура проекта:
```
ip-camera-surveillance-system/
├── shared/ # Kotlin Multiplatform модуль
│ ├── src/
│ │ ├── commonMain/ # Общий код для всех платформ
│ │ ├── androidMain/ # Android-специфичные реализации
│ │ ├── iosMain/ # iOS-специфичные реализации
│ │ └── desktopMain/ # Desktop-специфичные реализации
│ └── build.gradle.kts
├── android/ # Android приложение
│ ├── src/main/
│ └── build.gradle.kts
├── ios/ # iOS приложение
│ ├── IPCameraSurveillance/
│ └── IPCameraSurveillance.xcodeproj
├── desktop/ # Desktop приложения
│ ├── src/
│ └── build.gradle.kts
├── server/ # Серверная часть
│ ├── src/main/kotlin/
│ └── build.gradle.kts
├── native/ # Нативные C++ библиотеки
│ ├── video-processing/
│ ├── analytics/
│ └── CMakeLists.txt
├── core/ # Общие кроссплатформенные модули
│ ├── network/
│ ├── database/
│ ├── license/
│ └── utils/
└── docs/ # Документация
```

### Зависимости между модулями:
```
android/ios/desktop → shared → core → native
     ↓                ↓         ↓
  UI Layer      Domain Layer  Infrastructure
                      ↑
                  Data Layer
```

## Кроссплатформенная коммуникация

### 1. Общая бизнес-логика (KMM)
```kotlin
// shared/src/commonMain/kotlin/com/company/domain/
interface CameraRepository {
    suspend fun getCameras(): List<Camera>
    suspend fun addCamera(camera: Camera)
    suspend fun removeCamera(id: String)
}
```

### 2. Нативные библиотеки (C++)
```cmake
# Интеграция C++ библиотек через FFI (Foreign Function Interface)
native fun processVideoFrame(frame: ByteArray): ProcessedFrame
native fun detectObjects(frame: ByteArray): List<Detection>
native fun recognizeLicensePlate(image: ByteArray): String?
```

### 3. Сетевая синхронизация
- Протокол: HTTP/2 + Protocol Buffers
- Сервисы: Лицензионный сервер, синхронизация настроек, удаленное управление
- Безопасность: TLS 1.3, JWT токены, шифрование end-to-end

## Система лицензирования

Архитектура:
```
Клиент (любая платформа)
    ↓ (HTTPS + TLS)
Лицензионный сервер (микросервис)
    ↓
База лицензий (PostgreSQL)
    ↓
Система биллинга (интеграция)
```

Компоненты:
1. Клиентская библиотека (KMM) - проверка лицензии, офлайн-работа
2. Сервер лицензий (Spring Boot/Ktor) - управление лицензиями, генерация кодов
3. Административный портал (веб-интерфейс) - управление клиентами, лицензиями
4. Система уведомлений - напоминания об истечении, обновления

Безопасность:
- Асимметричное шифрование (RSA-2048/ECC) для подписей
- Симметричное шифрование (AES-256-GCM) для данных
- Привязка к устройству через аппаратные ключи
- Регулярная проверка отозванных лицензий (CRL/OCSP)

## Масштабирование и отказоустойчивость

### Вертикальное масштабирование:
- Оптимизация под разные классы устройств
- Адаптивная обработка видео
- Динамическое распределение ресурсов

### Горизонтальное масштабирование (enterprise):
```
Клиенты → Load Balancer → [Сервер 1, Сервер 2, Сервер N]
                              ↓
                       Общее хранилище (SAN/NAS)
                              ↓
                       База данных (кластер)
```

### Стратегии отказоустойчивости:
1. Репликация данных - синхронная/асинхронная репликация БД
2. Кластеризация - активный-активный или активный-пассивный
3. Геораспределение - дата-центры в разных регионах
4. Автоматическое восстановление - health checks, auto-restart

## Мониторинг и логирование

### Централизованное логирование:
- Структурированные логи (JSON)
- Сбор логов со всех компонентов
- Анализ и алертинг (ELK stack, Grafana)

### Метрики производительности:
- Время отклика API
- Использование ресурсов (CPU, память, диск, сеть)
- Качество видео (FPS, задержки, потеря кадров)
- Статистика пользователей (активные сессии, операции)

### Health checks:
- Endpoint /health на всех сервисах
- Проверка зависимостей (БД, внешние сервисы)
- Детальная информация о состоянии

## Развертывание

### Контейнеризация:
- Мульти-архитектурные образы (amd64, arm64)
- Многоступенчатые сборки для уменьшения размера
- Health checks и graceful shutdown

### Оркестрация (Kubernetes):
- Deployment для каждого микросервиса
- Service discovery и load balancing
- Horizontal Pod Autoscaling
- Rolling updates с blue-green deployment

### Инфраструктура как код:
- Terraform для облачных ресурсов
- Ansible для конфигурации
- GitOps для непрерывного развертывания

## Безопасность

### Защита данных:
- Шифрование данных в покое (AES-256)
- Шифрование данных в движении (TLS 1.3)
- Безопасное хранение ключей (HSM, Keychain, Keystore)

### Контроль доступа:
- Ролевая модель (RBAC)
- Многофакторная аутентификация
- Сессионное управление
- Аудит доступа

### Соответствие стандартам:
- GDPR - защита персональных данных
- ISO 27001 - управление информационной безопасностью
- SOC 2 - безопасность, доступность, конфиденциальность

