# –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –¥–µ–∫–æ–¥–µ—Ä–∞ H.264/H.265

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### Desktop (JVM)

1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ JavaCV/JavaCPP**:
   - `org.bytedeco:javacv:1.5.9`
   - `org.bytedeco:ffmpeg-platform:6.0-1.5.9`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ FFmpeg

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AVCodecContext**:
   - –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å `VideoDecoderImpl` —Å –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API FFmpeg –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ H.264 –∏ H.265
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è YUV420 –≤ RGB24 —á–µ—Ä–µ–∑ sws_scale

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ VideoDecoder.jvm.kt**:
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–µ–∫–æ–¥–µ—Ä–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### Native –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ cinterop –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞**:
   - `.def` —Ñ–∞–π–ª: `core/network/src/nativeInterop/cinterop/video_processing.def`
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `build.gradle.kts` –¥–ª—è –≤—Å–µ—Ö native –ø–ª–∞—Ç—Ñ–æ—Ä–º
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º

2. **–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ VideoDecoder.native.kt**:
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Ç–∏–≤–Ω—ã–º –¥–µ–∫–æ–¥–µ—Ä–æ–º
   - Callback –º–µ—Ö–∞–Ω–∏–∑–º —á–µ—Ä–µ–∑ StableRef
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤ Kotlin
   - –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**:
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `docs/VIDEO_DECODER_SETUP.md`
   - –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–±–æ—Ä–∫–∏ –Ω–∞—Ç–∏–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
   - –®–∞–≥–∏ –ø–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ cinterop –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
core/network/src/
‚îú‚îÄ‚îÄ commonMain/kotlin/.../video/
‚îÇ   ‚îî‚îÄ‚îÄ VideoDecoder.kt              # Expect –∫–ª–∞—Å—Å –∏ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ jvmMain/kotlin/.../video/
‚îÇ   ‚îú‚îÄ‚îÄ VideoDecoder.jvm.kt          # JVM —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (JavaCV)
‚îÇ   ‚îî‚îÄ‚îÄ VideoDecoderImpl.kt          # –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ AVCodecContext
‚îî‚îÄ‚îÄ nativeMain/kotlin/.../video/
    ‚îî‚îÄ‚îÄ VideoDecoder.native.kt       # Native —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (cinterop)

core/network/src/nativeInterop/cinterop/
‚îî‚îÄ‚îÄ video_processing.def             # Cinterop –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

docs/
‚îú‚îÄ‚îÄ VIDEO_DECODER_INTEGRATION.md     # –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ VIDEO_DECODER_SETUP.md           # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
‚îî‚îÄ‚îÄ VIDEO_DECODER_COMPLETE.md        # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Desktop (JVM)

```kotlin
import com.company.ipcamera.core.network.video.*

// –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–∫–æ–¥–µ—Ä–∞
val decoder = VideoDecoder(
    codec = VideoCodec.H264,
    width = 1920,
    height = 1080
)

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ callback
decoder.setCallback { decodedFrame ->
    val image = decodedFrame.toBufferedImage()
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
}

// –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–∞ –∏–∑ RTSP
val success = decoder.decode(rtspFrame)

// –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
decoder.release()
```

### Native –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ cinterop –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

```kotlin
import com.company.ipcamera.core.network.video.*

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ JVM –≤–µ—Ä—Å–∏–∏
val decoder = VideoDecoder(VideoCodec.H264, 1920, 1080)
decoder.setCallback { frame -> /* ... */ }
decoder.decode(rtspFrame)
decoder.release()
```

## ‚öôÔ∏è –ê–∫—Ç–∏–≤–∞—Ü–∏—è Native –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. **–°–æ–±—Ä–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É**:
   ```bash
   cd native/video-processing
   mkdir -p build && cd build
   cmake ..
   cmake --build .
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**:
   ```bash
   ls native/video-processing/lib/<platform>/<arch>/libvideo_processing.*
   ```

3. **–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ VideoDecoder.native.kt**:
   - –ò–º–ø–æ—Ä—Ç—ã cinterop
   - –ö–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–∫–æ–¥–µ—Ä–∞
   - –ö–æ–¥ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
   - –°—Ç—Ä—É–∫—Ç—É—Ä—É DecodedFrameStruct

4. **–°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç**:
   ```bash
   ./gradlew :core:network:build
   ```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### JVM (Desktop)

```kotlin
@Test
fun testH264Decoding() {
    val decoder = VideoDecoder(VideoCodec.H264, 1920, 1080)
    var decodedFrame: DecodedVideoFrame? = null

    decoder.setCallback { frame ->
        decodedFrame = frame
    }

    val rtspFrame = RtspFrame(
        data = h264NalUnit, // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        timestamp = System.currentTimeMillis(),
        streamType = RtspStreamType.VIDEO,
        width = 1920,
        height = 1080
    )

    val success = decoder.decode(rtspFrame)
    assertTrue(success)
    assertNotNull(decodedFrame)
    assertEquals(1920, decodedFrame!!.width)
    assertEquals(1080, decodedFrame!!.height)

    decoder.release()
}
```

### Native

–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–µ—Å—Ç—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã JVM –≤–µ—Ä—Å–∏–∏.

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### JVM (Desktop)

- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: ~50-100ms (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
- **–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–∞**: ~10-30ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)
- **–ü–∞–º—è—Ç—å**: ~50-100MB (FFmpeg –∫–æ–Ω—Ç–µ–∫—Å—Ç)

### Native

- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: ~10-20ms
- **–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–∞**: ~5-15ms
- **–ü–∞–º—è—Ç—å**: ~20-50MB

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **JVM**: –¢—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω—ã–µ NAL units (–Ω–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
2. **Native**: –¢—Ä–µ–±—É–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ cinterop –∏ —Å–±–æ—Ä–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
3. **–û–±–∞**: –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç SPS/PPS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑ –ø–æ—Ç–æ–∫–∞)

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ JavaCV
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AVCodecContext
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è native –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É SPS/PPS –¥–ª—è H.264
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É VPS/SPS/PPS –¥–ª—è H.265
6. ‚è≥ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
7. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ–¥–µ—Ä–æ–≤
8. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –î–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫—É
- –î–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª –¥–µ–∫–æ–¥–µ—Ä–æ–≤
- –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ (GPU) —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FFmpeg

