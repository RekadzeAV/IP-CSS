# Интеграция видеоплеера с RTSP - Документация

**Дата создания:** Декабрь 2025  
**Версия:** 2.0  
**Статус:** ✅ Реализовано

## Обзор

Реализована полная интеграция видеоплеера с RTSP клиентом для веб-интерфейса и Android приложения. Система включает генерацию HLS потоков, оптимизацию производительности, управление качеством и дополнительные функции.

## Архитектура

```
┌─────────────────────────────────────────────┐
│         VideoStreamService                  │
│  (Управление трансляцией RTSP потоков)     │
└──────────────┬──────────────────────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌──────────────┐  ┌──────────────────┐
│ RtspClient   │  │ HlsGeneratorService│
│ (RTSP потоки)│  │ (FFmpeg генерация) │
└──────────────┘  └──────────────────┘
       │               │
       └───────┬───────┘
               ▼
       ┌───────────────┐
       │   Клиенты     │
       │  (Web/Android)│
       └───────────────┘
```

## Основные компоненты

### 1. VideoStreamService

Сервис для управления трансляцией видеопотоков с IP-камер.

**Возможности:**
- Управление жизненным циклом RTSP потоков
- Интеграция с HLS генерацией
- Оптимизированная буферизация с управлением памятью
- Автоматическая очистка неактивных стримов
- Поддержка разных уровней качества

**Основные методы:**
```kotlin
suspend fun startStream(cameraId: String): Result<String>
suspend fun stopStream(cameraId: String): Result<Unit>
fun getHlsUrl(cameraId: String): String?
suspend fun setStreamQuality(cameraId: String, quality: StreamQuality): Result<Unit>
```

### 2. HlsGeneratorService

Сервис для генерации HLS сегментов из RTSP потоков через FFmpeg.

**Возможности:**
- Автоматическая генерация HLS сегментов
- Поддержка разных уровней качества
- Управление процессами FFmpeg
- Автоматическая очистка старых сегментов

**Уровни качества:**
- `LOW`: 640x360, 500kbps, 15fps
- `MEDIUM`: 1280x720, 1500kbps, 25fps
- `HIGH`: 1920x1080, 3000kbps, 30fps
- `ULTRA`: 1920x1080, 6000kbps, 30fps, fast preset

### 3. ScreenshotService

Сервис для создания снимков кадров из видеопотоков.

**Возможности:**
- Создание снимков из RTSP потоков через FFmpeg
- Автоматическая очистка старых снимков
- Хранение снимков с временными метками

## API Endpoints

### Управление стримами

#### POST `/api/v1/cameras/{id}/stream/start`
Запустить трансляцию для камеры.

**Ответ:**
```json
{
  "success": true,
  "data": "stream-id-uuid",
  "message": "Stream started successfully"
}
```

#### POST `/api/v1/cameras/{id}/stream/stop`
Остановить трансляцию для камеры.

#### GET `/api/v1/cameras/{id}/stream/status`
Получить статус трансляции.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "active": true,
    "streamId": "stream-id-uuid",
    "hlsUrl": "/api/v1/cameras/{id}/stream/hls/playlist.m3u8",
    "rtspUrl": null
  }
}
```

### HLS потоки

#### GET `/api/v1/cameras/{id}/stream/hls/playlist.m3u8`
Получить HLS плейлист (требует аутентификации).

#### GET `/api/v1/cameras/streams/{streamId}/hls/playlist.m3u8`
Получить HLS плейлист по streamId (без аутентификации для доступа к сегментам).

#### GET `/api/v1/cameras/streams/{streamId}/hls/segment_XXX.ts`
Получить HLS сегмент (без аутентификации).

### RTSP URL

#### GET `/api/v1/cameras/{id}/stream/rtsp`
Получить RTSP URL для прямой трансляции (для ExoPlayer).

**Ответ:**
```json
{
  "success": true,
  "data": {
    "rtspUrl": "rtsp://username:password@host:port/path"
  }
}
```

### Снимки

#### POST `/api/v1/cameras/{id}/stream/screenshot`
Создать снимок текущего кадра.

**Ответ:**
```json
{
  "success": true,
  "data": "/api/v1/screenshots/camera-id_timestamp.jpg",
  "message": "Screenshot captured successfully"
}
```

## Веб-интерфейс

### VideoPlayer Component

React компонент для воспроизведения HLS потоков.

**Возможности:**
- Интеграция с HLS.js для браузеров без нативной поддержки HLS
- Нативная поддержка HLS для Safari
- Контролы воспроизведения (play/pause/stop)
- Полноэкранный режим
- Управление качеством
- Снимки кадров

**Использование:**
```tsx
<VideoPlayer
  camera={camera}
  autoPlay={true}
  controls={true}
  width="100%"
  height="auto"
/>
```

### StreamService

Сервис для работы с API стримов.

```typescript
// Начать трансляцию
await streamService.startStream(cameraId);

// Остановить трансляцию
await streamService.stopStream(cameraId);

// Получить статус
const status = await streamService.getStreamStatus(cameraId);

// Получить HLS URL
const hlsUrl = streamService.getHlsUrl(cameraId);
```

## Android приложение

### ExoVideoPlayer Component

Compose компонент для воспроизведения RTSP потоков через ExoPlayer.

**Возможности:**
- Воспроизведение RTSP потоков
- Встроенные контролы ExoPlayer
- Автоматическое управление жизненным циклом

**Использование:**
```kotlin
ExoVideoPlayer(
    videoUrl = rtspUrl,
    autoPlay = true,
    modifier = Modifier.fillMaxSize(),
    onError = { error -> /* обработка ошибки */ }
)
```

### VideoViewViewModel

ViewModel для управления видеоплеером.

**Возможности:**
- Загрузка информации о камере
- Управление трансляцией (start/stop)
- Получение RTSP URL
- Управление состоянием воспроизведения

## Оптимизация производительности

### Буферизация

- Используется `MutableSharedFlow` с ограниченным буфером (50 кадров по умолчанию)
- Стратегия переполнения: `DROP_OLDEST` (удаление самых старых кадров)
- Автоматическое управление памятью

### Управление памятью

- Автоматическая очистка неактивных стримов (таймаут 30 минут)
- Ограничение размера буфера кадров
- Очистка HLS сегментов при остановке стрима

### Конфигурация

```kotlin
VideoStreamService(
    cameraRepository = cameraRepository,
    hlsGeneratorService = hlsGeneratorService,
    streamsDirectory = "streams",
    maxBufferSize = 50, // Максимальное количество кадров в буфере
    streamTimeoutMinutes = 30 // Таймаут неактивного стрима
)
```

## Требования

### Серверная часть

- FFmpeg установлен и доступен в PATH
- Достаточно места на диске для HLS сегментов (рекомендуется минимум 10GB)
- Достаточно оперативной памяти для буферизации (рекомендуется минимум 2GB)

### Веб-интерфейс

- Браузер с поддержкой HLS (Safari нативно, другие через HLS.js)
- JavaScript включен
- Современный браузер (Chrome, Firefox, Safari, Edge)

### Android

- Android API 26+
- ExoPlayer (Media3) версия 1.2.1+
- Достаточно памяти для буферизации видео

## Известные ограничения

1. **Декодирование кадров для снимков**: Текущая реализация использует FFmpeg для создания снимков из RTSP потока. Прямое декодирование H.264 кадров из `RtspFrame` требует дополнительной реализации.

2. **HLS сегменты**: Сегменты хранятся на диске и не удаляются автоматически сразу после остановки стрима (для возможности перемотки). Требуется периодическая очистка.

3. **Управление качеством в реальном времени**: Изменение качества требует перезапуска HLS генерации, что может вызвать кратковременное прерывание потока.

## Рекомендации по использованию

1. **Производственная среда**:
   - Используйте CDN для раздачи HLS сегментов
   - Настройте автоматическую очистку старых сегментов
   - Мониторьте использование дискового пространства
   - Настройте лимиты на количество одновременных стримов

2. **Производительность**:
   - Настройте `maxBufferSize` в зависимости от доступной памяти
   - Используйте подходящий уровень качества для каждого случая использования
   - Мониторьте нагрузку на FFmpeg процессы

3. **Безопасность**:
   - Рассмотрите добавление токенов для доступа к HLS сегментам
   - Ограничьте доступ к API endpoints
   - Используйте HTTPS для production

## Следующие шаги

1. **Улучшения**:
   - Реализовать прямую поддержку WebRTC для более низкой задержки
   - Добавить адаптивное качество (ABR)
   - Реализовать декодирование кадров без FFmpeg для снимков
   - Добавить поддержку аудио потоков

2. **Оптимизация**:
   - Кэширование HLS плейлистов
   - Оптимизация параметров FFmpeg
   - Использование аппаратного ускорения

## Связанные документы

- [RTSP_CLIENT.md](RTSP_CLIENT.md) - Документация RTSP клиента
- [RTSP_CLIENT_INTEGRATION.md](RTSP_CLIENT_INTEGRATION.md) - Руководство по интеграции
- [ARCHITECTURE.md](ARCHITECTURE.md) - Архитектура системы

---

**Последнее обновление:** Декабрь 2025

