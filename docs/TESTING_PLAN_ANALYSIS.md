# Анализ плана тестирования IP-CSS

## Дата анализа
2025-01-XX

## Обзор текущего состояния

### Существующие тесты
- ✅ **Use Cases**: 5 из 15+ (AddCamera, GetCameras, GetCameraById, UpdateCamera, DeleteCamera)
- ✅ **Repositories**: CameraRepositoryImpl (базовые CRUD операции)
- ✅ **Mappers**: CameraEntityMapper (полное покрытие)
- ⚠️ **LicenseManager**: Частичное покрытие (placeholder тесты, ограничения из-за expect классов)

### Статистика
- Всего тестовых классов: 8
- Всего тестов: ~35+
- Покрытие: ~25-30% от критически важных компонентов

---

## 1. Исправления текущих тестов

### 1.1 LicenseManagerTest

#### Проблемы:
- ❌ **Placeholder тест** `test validate on startup with no license` - только `assertTrue(true)`
- ❌ Отсутствуют тесты для реальной логики LicenseManager
- ❌ Нет тестов для методов активации лицензий
- ❌ Нет тестов для валидации лицензий

#### Исправления:
1. **Удалить placeholder тест** или заменить на реальную проверку
2. **Добавить тесты для LicenseManager.validateLicense()** (если доступно через моки)
3. **Добавить тесты для LicenseManager.activateLicense()** (если доступно)
4. **Добавить тесты для проверки функций лицензии** (supportsFeature)
5. **Расширить тесты для ActivatedLicense**:
   - Тесты для perpetual лицензий
   - Тесты граничных значений дат
   - Тесты для разных типов активации

---

### 1.2 CameraRepositoryImplTest

#### Проблемы:
- ❌ **Заглушки вместо реальных тестов**: `test discover cameras` и `test test connection` возвращают пустые/нереализованные результаты
- ❌ Отсутствуют edge cases для операций с БД
- ❌ Нет тестов для конкурентного доступа
- ❌ Нет тестов для обработки ошибок БД

#### Исправления:
1. **Улучшить тесты discoverCameras()**:
   - Добавить моки для OnvifClient
   - Тестировать реальные сценарии обнаружения
   - Тестировать обработку ошибок сети

2. **Улучшить тесты testConnection()**:
   - Добавить моки для OnvifClient
   - Тестировать успешное подключение
   - Тестировать различные типы ошибок подключения

3. **Добавить тесты edge cases**:
   - Добавление камеры с дублирующимся ID
   - Обновление несуществующей камеры
   - Работа с очень длинными значениями полей
   - Работа с null значениями в опциональных полях
   - Тесты производительности для больших объемов данных

4. **Добавить тесты обработки ошибок**:
   - Ошибки подключения к БД
   - Ошибки SQL запросов
   - Ошибки сериализации/десериализации JSON

---

### 1.3 Use Case Tests

#### Проблемы:
- ❌ **Повторяющийся код**: Каждый тест создает mock repository с полной реализацией интерфейса
- ❌ Отсутствуют тесты для валидации входных данных
- ❌ Нет тестов для граничных случаев
- ❌ Недостаточное покрытие ошибок

#### Исправления:
1. **Рефакторинг mock объектов**:
   - Создать `MockCameraRepository` класс для переиспользования
   - Использовать библиотеку для моков (например, mockk для JVM тестов)

2. **Добавить тесты валидации для AddCameraUseCase**:
   - Пустое имя камеры
   - Невалидный URL (не RTSP)
   - Очень длинные строки
   - Специальные символы в именах

3. **Расширить тесты для всех Use Cases**:
   - Тесты с null значениями
   - Тесты с пустыми строками
   - Тесты производительности

4. **Улучшить обработку ошибок**:
   - Тесты для различных типов исключений
   - Тесты для каскадных ошибок

---

### 1.4 CameraEntityMapperTest

#### Проблемы:
- ⚠️ Отсутствуют тесты для некоторых edge cases
- ❌ Нет тестов для всех типов полей (все StreamConfig варианты, все PTZConfig варианты)

#### Исправления:
1. **Добавить тесты для всех типов полей**:
   - Тесты для всех вариантов StreamConfig
   - Тесты для всех типов PTZConfig
   - Тесты для различных значений CameraStatistics

2. **Добавить тесты для обработки ошибок**:
   - Некорректный JSON в ptz_config
   - Некорректный JSON в streams
   - Некорректный JSON в settings

3. **Добавить тесты для граничных значений**:
   - Минимальные/максимальные значения разрешения
   - Граничные значения временных меток

---

### 1.5 TestDataFactory и TestDatabaseFactory

#### Проблемы:
- ⚠️ Недостаточно вспомогательных методов для создания тестовых данных

#### Исправления:
1. **Расширить TestDataFactory**:
   - Методы для создания Event тестовых данных
   - Методы для создания Recording тестовых данных
   - Методы для создания Settings тестовых данных
   - Методы для создания User тестовых данных
   - Методы для создания Notification тестовых данных

2. **Добавить методы для edge cases**:
   - Создание данных с минимальными полями
   - Создание данных с максимальными значениями
   - Создание данных с null значениями

---

## 2. Разработка новых тестов

### 2.1 Use Cases (10+ новых тестовых классов)

#### 2.1.1 Recording Use Cases
- ❌ **StartRecordingUseCaseTest**
  - Тест успешного начала записи
  - Тест начала записи для несуществующей камеры
  - Тест начала записи при уже активной записи
  - Тест обработки ошибок репозитория

- ❌ **StopRecordingUseCaseTest**
  - Тест успешной остановки записи
  - Тест остановки несуществующей записи
  - Тест остановки уже остановленной записи

- ❌ **PauseRecordingUseCaseTest**
  - Тест успешной паузы записи
  - Тест паузы несуществующей записи
  - Тест паузы уже приостановленной записи

- ❌ **ResumeRecordingUseCaseTest**
  - Тест успешного возобновления записи
  - Тест возобновления несуществующей записи

- ❌ **GetRecordingsUseCaseTest**
  - Тест получения списка записей
  - Тест фильтрации по камере
  - Тест фильтрации по времени
  - Тест пагинации
  - Тест пустого списка

- ❌ **DeleteRecordingUseCaseTest**
  - Тест успешного удаления записи
  - Тест удаления несуществующей записи
  - Тест обработки ошибок

#### 2.1.2 Discovery Use Cases
- ❌ **DiscoverCamerasUseCaseTest**
  - Тест успешного обнаружения камер
  - Тест обнаружения при отсутствии камер
  - Тест обработки ошибок сети
  - Тест обработки таймаутов

- ❌ **AddDiscoveredCameraUseCaseTest**
  - Тест добавления обнаруженной камеры
  - Тест добавления с минимальными данными
  - Тест обработки ошибок валидации

- ❌ **DiscoverAndAddCameraUseCaseTest**
  - Тест полного цикла обнаружения и добавления
  - Тест обработки ошибок на каждом этапе

- ❌ **TestDiscoveredCameraUseCaseTest**
  - Тест проверки подключения к обнаруженной камере
  - Тест различных результатов проверки

---

### 2.2 Repositories (5+ новых тестовых классов)

#### 2.2.1 EventRepositoryImplTest
- ❌ CRUD операции для событий
- ❌ Фильтрация событий (по типу, камере, severity, acknowledged)
- ❌ Пагинация событий
- ❌ Подтверждение событий (одиночное и массовое)
- ❌ Статистика событий
- ❌ Тесты производительности для больших объемов

#### 2.2.2 RecordingRepositoryImplTest
- ❌ CRUD операции для записей
- ❌ Фильтрация записей (по камере, времени)
- ❌ Пагинация записей
- ❌ Получение URL для скачивания
- ❌ Экспорт записей

#### 2.2.3 SettingsRepositoryImplTest
- ❌ Получение настроек (все, по категории, по ключу)
- ❌ Обновление настроек (одиночное и множественное)
- ❌ Удаление настроек
- ❌ Системные настройки (get/update)
- ❌ Сброс настроек
- ❌ Импорт/экспорт настроек

#### 2.2.4 UserRepositoryImplTest
- ❌ CRUD операции для пользователей
- ❌ Поиск пользователей
- ❌ Управление ролями и правами доступа
- ❌ Аутентификация пользователей

#### 2.2.5 NotificationRepositoryImplTest
- ❌ CRUD операции для уведомлений
- ❌ Фильтрация уведомлений
- ❌ Отметка прочитанными
- ❌ Удаление старых уведомлений

---

### 2.3 Mappers (4+ новых тестовых классов)

- ❌ **EventEntityMapperTest**
  - Конвертация Event domain ↔ database
  - Обработка всех типов событий
  - Обработка всех уровней severity

- ❌ **RecordingEntityMapperTest**
  - Конвертация Recording domain ↔ database
  - Обработка всех статусов записи
  - Обработка метаданных записи

- ❌ **SettingsEntityMapperTest**
  - Конвертация Settings domain ↔ database
  - Обработка всех категорий настроек
  - Обработка системных настроек

- ❌ **UserEntityMapperTest**
  - Конвертация User domain ↔ database
  - Обработка ролей и прав доступа

---

### 2.4 Server Components (10+ новых тестовых классов)

#### 2.4.1 Middleware Tests

- ❌ **RateLimitMiddlewareTest**
  - Тест проверки лимитов для различных конфигураций
  - Тест sliding window алгоритма
  - Тест блокировки после превышения лимита
  - Тест восстановления после истечения блокировки
  - Тест для различных идентификаторов (IP, user ID)
  - Тест обработки ошибок Redis

- ❌ **AuthorizationMiddlewareTest**
  - Тест проверки прав доступа для разных ролей
  - Тест доступа к ресурсам
  - Тест обработки отсутствующих прав
  - Тест обработки невалидных токенов

- ❌ **ValidationMiddlewareTest**
  - Тест валидации различных типов запросов
  - Тест обработки невалидных данных
  - Тест обработки отсутствующих полей

- ❌ **CookieAuthMiddlewareTest**
  - Тест аутентификации через cookies
  - Тест обработки отсутствующих cookies
  - Тест обработки истекших cookies

#### 2.4.2 Service Tests

- ❌ **PasswordServiceTest**
  - Тест хеширования паролей
  - Тест проверки правильных паролей
  - Тест проверки неправильных паролей
  - Тест определения BCrypt хешей
  - Тест безопасности (одинаковые пароли дают разные хеши)

- ❌ **VideoRecordingServiceTest**
  - Тест начала записи
  - Тест остановки записи
  - Тест паузы/возобновления записи
  - Тест обработки ошибок FFmpeg
  - Тест управления файлами записей

- ❌ **VideoStreamServiceTest**
  - Тест создания потока
  - Тест управления качеством потока
  - Тест обработки ошибок потока

- ❌ **HlsGeneratorServiceTest**
  - Тест генерации HLS сегментов
  - Тест создания плейлистов
  - Тест обработки ошибок

- ❌ **ScreenshotServiceTest**
  - Тест создания скриншотов
  - Тест обработки ошибок

- ❌ **FfmpegServiceTest**
  - Тест выполнения FFmpeg команд
  - Тест обработки ошибок FFmpeg
  - Тест таймаутов

- ❌ **StorageServiceTest**
  - Тест сохранения файлов
  - Тест удаления файлов
  - Тест проверки места на диске
  - Тест обработки ошибок файловой системы

#### 2.4.3 Server Repository Tests

- ❌ **ServerUserRepositoryTest**
  - CRUD операции
  - Поиск пользователей
  - Аутентификация
  - Управление ролями

- ❌ **ServerEventRepositoryTest**
  - CRUD операции
  - Фильтрация и пагинация
  - Статистика

- ❌ **ServerRecordingRepositoryTest**
  - CRUD операции
  - Фильтрация и пагинация

- ❌ **ServerSettingsRepositoryTest**
  - CRUD операции
  - Импорт/экспорт
  - Сброс настроек

---

### 2.5 Network Components (3+ новых тестовых классов)

- ❌ **OnvifClientTest** (частично можно тестировать)
  - Тест парсинга XML ответов
  - Тест формирования SOAP запросов
  - Тест обработки ошибок
  - Моки для HTTP запросов

- ❌ **WebSocketClientTest**
  - Тест подключения/отключения
  - Тест отправки/получения сообщений
  - Тест автоматического переподключения
  - Тест обработки ошибок

- ❌ **RtspClientTest** (ограниченно, требует нативной библиотеки)
  - Тест инициализации клиента
  - Тест обработки статусов
  - Моки для нативного клиента

---

### 2.6 Integration Tests

#### 2.6.1 API Integration Tests
- ❌ **AuthRoutesIntegrationTest**
  - Тест успешного логина
  - Тест неправильных учетных данных
  - Тест refresh токенов
  - Тест logout

- ❌ **CameraRoutesIntegrationTest**
  - Тест всех CRUD операций через API
  - Тест фильтрации и пагинации
  - Тест обнаружения камер
  - Тест проверки подключения

- ❌ **EventRoutesIntegrationTest**
  - Тест всех операций с событиями через API
  - Тест подтверждения событий
  - Тест статистики

- ❌ **RecordingRoutesIntegrationTest**
  - Тест всех операций с записями через API
  - Тест скачивания записей
  - Тест экспорта

- ❌ **SettingsRoutesIntegrationTest**
  - Тест всех операций с настройками через API
  - Тест импорта/экспорта
  - Тест сброса настроек

#### 2.6.2 Database Integration Tests
- ❌ **CameraRepositoryDatabaseTest**
  - Тесты с реальной in-memory БД
  - Тесты транзакций
  - Тесты миграций (если есть)

---

### 2.7 Utility Tests

- ❌ **RequestValidatorTest**
  - Тест валидации различных типов запросов
  - Тест обработки невалидных данных

- ❌ **SecurityLoggerTest**
  - Тест логирования событий безопасности
  - Тест различных уровней логирования

---

## Приоритизация разработки

### Высокий приоритет (критично для стабильности)
1. ✅ Исправление placeholder тестов в LicenseManagerTest
2. ✅ Тесты для PasswordService (критично для безопасности)
3. ✅ Тесты для RateLimitMiddleware (защита от атак)
4. ✅ Тесты для всех Recording Use Cases
5. ✅ Тесты для EventRepository и RecordingRepository

### Средний приоритет (важно для функциональности)
6. ✅ Тесты для Server Services (VideoRecordingService, VideoStreamService)
7. ✅ Тесты для Discovery Use Cases
8. ✅ Тесты для всех Mappers
9. ✅ Тесты для SettingsRepository
10. ✅ API Integration Tests

### Низкий приоритет (улучшение покрытия)
11. ✅ Тесты для Network Components (с ограничениями)
12. ✅ Расширенные edge case тесты
13. ✅ Performance тесты
14. ✅ E2E тесты

---

## Рекомендации по реализации

### Инструменты и библиотеки
1. **Для моков**:
   - JVM тесты: `mockk` или `mockito`
   - Common тесты: создать собственные mock классы (как сейчас)

2. **Для тестирования корутин**:
   - Использовать `kotlinx-coroutines-test` (уже используется)

3. **Для integration тестов**:
   - Использовать `ktor-server-test-host` для тестирования API
   - Использовать `app.cash.sqldelight:sqlite-driver` для тестов БД (уже используется)

4. **Для покрытия кода**:
   - Настроить JaCoCo или аналогичный инструмент
   - Установить минимальный порог покрытия (например, 70%)

### Структура тестов
```
shared/src/commonTest/
├── domain/usecase/
│   ├── camera/ (существующие)
│   ├── recording/ (новые)
│   ├── discovery/ (новые)
│   └── event/ (новые, если будут Use Cases)
├── data/repository/
│   ├── CameraRepositoryImplTest.kt (улучшить)
│   ├── EventRepositoryImplTest.kt (новый)
│   ├── RecordingRepositoryImplTest.kt (новый)
│   ├── SettingsRepositoryImplTest.kt (новый)
│   └── UserRepositoryImplTest.kt (новый)
├── data/local/
│   ├── CameraEntityMapperTest.kt (расширить)
│   ├── EventEntityMapperTest.kt (новый)
│   ├── RecordingEntityMapperTest.kt (новый)
│   └── SettingsEntityMapperTest.kt (новый)
└── test/
    ├── TestDataFactory.kt (расширить)
    └── TestDatabaseFactory.kt
    └── mocks/ (новые mock классы)

server/api/src/test/ (новые тесты для сервера)
├── middleware/
│   ├── RateLimitMiddlewareTest.kt
│   ├── AuthorizationMiddlewareTest.kt
│   └── ValidationMiddlewareTest.kt
├── service/
│   ├── PasswordServiceTest.kt
│   ├── VideoRecordingServiceTest.kt
│   └── ...
└── repository/
    ├── ServerUserRepositoryTest.kt
    └── ...

server/api/src/testIntegration/ (integration тесты)
├── api/
│   ├── AuthRoutesIntegrationTest.kt
│   ├── CameraRoutesIntegrationTest.kt
│   └── ...
```

### Метрики успеха
- **Покрытие кода**: минимум 70% для критических компонентов
- **Количество тестов**: увеличить с ~35 до 200+
- **Время выполнения**: все тесты должны выполняться за < 5 минут
- **Стабильность**: 0 flaky тестов

---

## Заключение

Текущее состояние тестирования требует значительных улучшений. Критично важно:
1. Исправить существующие placeholder тесты
2. Добавить тесты для всех Use Cases
3. Добавить тесты для серверных компонентов (безопасность и middleware)
4. Создать integration тесты для API

Рекомендуется начать с исправления существующих тестов и разработки тестов для компонентов, связанных с безопасностью и критической функциональностью.

