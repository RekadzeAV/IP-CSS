# Анализ создания копии репозитория из GitHub в Git на Synology RS2416+ (DSM 7.2)

**Дата создания:** Январь 2025
**Версия проекта:** Alfa-0.0.1
**Целевое устройство:** Synology RS2416+ под управлением DSM 7.2

---

## Содержание

1. [Характеристики Synology RS2416+](#характеристики-synology-rs2416)
2. [Установка Git Server на DSM 7.2](#установка-git-server-на-dsm-72)
3. [Создание зеркала репозитория GitHub](#создание-зеркала-репозитория-github)
4. [Настройка автоматической синхронизации](#настройка-автоматической-синхронизации)
5. [Настройка доступа и безопасности](#настройка-доступа-и-безопасности)
6. [Резервное копирование](#резервное-копирование)
7. [Мониторинг и обслуживание](#мониторинг-и-обслуживание)
8. [Устранение неполадок](#устранение-неполадок)

---

## Характеристики Synology RS2416+

### Аппаратные характеристики

- **Процессор:** Intel Atom C2538 (x86_64, 4 ядра @ 2.4 GHz)
- **Память:** 2-16 ГБ DDR3 (рекомендуется минимум 4 ГБ)
- **Слоты:** 12x 3.5" SATA (поддержка hot-swap)
- **Сеть:** 4x Gigabit Ethernet (с возможностью агрегации)
- **Порты:** USB 3.0, eSATA
- **ОС:** DSM 7.2 (Linux-based, Debian)

### Программные возможности

- **Git Server:** Встроенный пакет в Package Center
- **SSH доступ:** Полная поддержка
- **Docker:** Поддержка контейнеризации
- **Резервное копирование:** Hyper Backup, Snapshot Replication
- **Файловые системы:** Btrfs, ext4

---

## Установка Git Server на DSM 7.2

### Способ 1: Через веб-интерфейс (рекомендуется)

1. **Открыть Package Center:**
   - Войдите в DSM веб-интерфейс
   - Откройте **Package Center** (Центр пакетов)

2. **Установка Git Server:**
   - Найдите пакет **"Git Server"**
   - Нажмите **"Установить"**
   - Дождитесь завершения установки

3. **Запуск службы:**
   - Откройте установленный **Git Server**
   - Включите службу
   - Настройте порт (по умолчанию: 22 для SSH, 9418 для Git протокола)

### Способ 2: Через SSH (альтернатива)

```bash
# Подключение к Synology
ssh admin@<IP_SYNOLOGY>

# Проверка установки Git
git --version

# Если Git не установлен, можно установить через ipkg (если доступен)
# или использовать Docker образ с Git
```

---

## Создание зеркала репозитория GitHub

### Шаг 1: Подготовка директории

```bash
# Подключение к Synology через SSH
ssh admin@<IP_SYNOLOGY>

# Создание директории для репозиториев
sudo mkdir -p /volume1/git
sudo chmod 755 /volume1/git

# Создание пользователя для Git (если еще не создан)
# Через веб-интерфейс: Панель управления > Пользователь > Создать
# Или через SSH:
sudo synouser --add gituser <password> "" "" 0 "" 0
```

### Шаг 2: Настройка прав доступа

```bash
# Назначение прав пользователю gituser
sudo chown -R gituser:users /volume1/git
sudo chmod -R 755 /volume1/git

# Настройка через веб-интерфейс:
# 1. Панель управления > Общие папки
# 2. Создать общую папку "git" или использовать существующую
# 3. Назначить права доступа пользователю gituser
```

### Шаг 3: Клонирование репозитория с GitHub

#### Вариант 1: Bare репозиторий с зеркалированием (рекомендуется)

```bash
# Переключение на пользователя gituser
sudo su - gituser

# Переход в директорию репозиториев
cd /volume1/git

# Клонирование bare репозитория с зеркалированием
# Для публичного репозитория:
git clone --bare --mirror https://github.com/your-org/IP-CSS.git IP-CSS.git

# Для приватного репозитория (требуется SSH ключ):
# 1. Сначала настроить SSH ключ на GitHub
# 2. Затем:
git clone --bare --mirror git@github.com:your-org/IP-CSS.git IP-CSS.git

# Настройка зеркалирования
cd IP-CSS.git
git config remote.origin.fetch "+refs/*:refs/*"
git config remote.origin.mirror true
git config --bool core.bare true
```

#### Вариант 2: Обычный репозиторий с зеркалированием

```bash
# Клонирование обычного репозитория
git clone https://github.com/your-org/IP-CSS.git /volume1/git/IP-CSS

# Настройка зеркалирования
cd /volume1/git/IP-CSS
git remote set-url origin https://github.com/your-org/IP-CSS.git
git config remote.origin.fetch "+refs/*:refs/*"
```

### Шаг 4: Проверка зеркала

```bash
# Проверка структуры репозитория
cd /volume1/git/IP-CSS.git
git branch -a
git tag -l

# Проверка размера
du -sh /volume1/git/IP-CSS.git

# Проверка целостности
git fsck --full
```

---

## Настройка автоматической синхронизации

### Способ 1: Cron задача (через SSH)

```bash
# Создание скрипта синхронизации
sudo nano /volume1/git/sync-ip-css.sh
```

**Содержимое скрипта:**

```bash
#!/bin/bash
# Скрипт синхронизации зеркала репозитория IP-CSS

REPO_PATH="/volume1/git/IP-CSS.git"
LOG_FILE="/volume1/git/sync-ip-css.log"
LOCK_FILE="/volume1/git/sync-ip-css.lock"

# Проверка блокировки (предотвращение параллельных запусков)
if [ -f "$LOCK_FILE" ]; then
    echo "$(date): Sync already running, skipping..." >> "$LOG_FILE"
    exit 0
fi

# Создание блокировки
touch "$LOCK_FILE"

# Переход в директорию репозитория
cd "$REPO_PATH" || exit 1

# Синхронизация с GitHub
echo "$(date): Starting sync..." >> "$LOG_FILE"
git fetch --prune origin 2>&1 | tee -a "$LOG_FILE"

# Проверка результата
if [ $? -eq 0 ]; then
    echo "$(date): Sync completed successfully" >> "$LOG_FILE"

    # Обновление всех веток и тегов
    git remote update --prune 2>&1 | tee -a "$LOG_FILE"
else
    echo "$(date): Sync failed!" >> "$LOG_FILE"
fi

# Удаление блокировки
rm -f "$LOCK_FILE"
```

**Настройка прав и добавление в cron:**

```bash
# Права на выполнение
sudo chmod +x /volume1/git/sync-ip-css.sh
sudo chown gituser:users /volume1/git/sync-ip-css.sh

# Редактирование crontab для пользователя gituser
sudo crontab -u gituser -e

# Добавить строку (синхронизация каждый час):
0 * * * * /volume1/git/sync-ip-css.sh

# Или каждые 6 часов:
0 */6 * * * /volume1/git/sync-ip-css.sh

# Или ежедневно в 3:00:
0 3 * * * /volume1/git/sync-ip-css.sh
```

### Способ 2: Планировщик задач DSM (через веб-интерфейс)

1. **Открыть планировщик задач:**
   - Панель управления > Планировщик задач

2. **Создать задачу:**
   - Нажать **"Создать"** > **"Запланированная задача"** > **"Пользовательский скрипт"**

3. **Настройка задачи:**
   - **Имя задачи:** Sync IP-CSS Repository
   - **Пользователь:** gituser
   - **Расписание:** Настроить по необходимости (например, каждый час)
   - **Задача:** Выбрать скрипт `/volume1/git/sync-ip-css.sh`

4. **Сохранить задачу**

### Способ 3: Git hooks (для push-уведомлений)

```bash
# Создание post-receive hook для автоматической синхронизации при push
cd /volume1/git/IP-CSS.git/hooks
sudo nano post-receive
```

**Содержимое post-receive:**

```bash
#!/bin/bash
# Автоматическая синхронизация при получении push

REPO_PATH="/volume1/git/IP-CSS.git"
cd "$REPO_PATH"

# Синхронизация с GitHub
git fetch --prune origin
```

```bash
# Права на выполнение
sudo chmod +x /volume1/git/IP-CSS.git/hooks/post-receive
```

---

## Настройка доступа и безопасности

### Настройка SSH доступа

1. **Включение SSH:**
   - Панель управления > Терминал и SNMP
   - Включить службу SSH
   - Порт: 22 (или другой)
   - Разрешить только SFTP (опционально)

2. **Настройка SSH ключей:**

```bash
# На клиентской машине
ssh-keygen -t ed25519 -C "your_email@example.com"

# Копирование ключа на Synology
ssh-copy-id gituser@<IP_SYNOLOGY>

# Или вручную:
cat ~/.ssh/id_ed25519.pub | ssh gituser@<IP_SYNOLOGY> "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

3. **Отключение парольной аутентификации (рекомендуется):**

```bash
# Редактирование SSH конфигурации
sudo nano /etc/ssh/sshd_config

# Изменить:
# PasswordAuthentication no
# PubkeyAuthentication yes

# Перезапуск SSH
sudo systemctl restart sshd
```

### Настройка Git Server через веб-интерфейс

1. **Открыть Git Server:**
   - Package Center > Git Server

2. **Добавить репозиторий:**
   - Нажать **"Добавить"**
   - Указать путь: `/volume1/git/IP-CSS.git`
   - Настроить права доступа для пользователей/групп

3. **Настройка доступа:**
   - **Чтение:** Пользователи, которым нужен доступ только для чтения
   - **Запись:** Пользователи, которым нужен доступ для записи
   - **Администратор:** Пользователи с полным доступом

### Настройка Firewall

1. **Панель управления > Безопасность > Брандмауэр:**
   - Разрешить порт 22 (SSH) для доверенных IP
   - Разрешить порт 9418 (Git протокол) при необходимости
   - Ограничить доступ по IP адресам

### Использование репозитория

**Клонирование с Synology:**

```bash
# Через SSH
git clone gituser@<IP_SYNOLOGY>:/volume1/git/IP-CSS.git

# Через Git Server (если настроен)
git clone git://<IP_SYNOLOGY>/IP-CSS.git

# Или через HTTPS (если настроен веб-сервер)
git clone https://<IP_SYNOLOGY>/git/IP-CSS.git
```

---

## Резервное копирование

### Способ 1: Hyper Backup (встроенный инструмент DSM)

1. **Открыть Hyper Backup:**
   - Package Center > Hyper Backup

2. **Создать задачу резервного копирования:**
   - **Тип:** Локальная папка и USB
   - **Источник:** Выбрать `/volume1/git`
   - **Назначение:** Выбрать место для резервных копий
   - **Расписание:** Настроить (например, ежедневно в 2:00)

3. **Настройка версионирования:**
   - Включить версионирование
   - Настроить количество версий (например, 30 дней)

### Способ 2: Ручное резервное копирование

```bash
# Создание архива репозитория
cd /volume1/git
tar -czf IP-CSS-backup-$(date +%Y%m%d).tar.gz IP-CSS.git

# Копирование на внешний диск или сетевой ресурс
# (настроить через File Station или командную строку)
```

### Способ 3: Snapshot Replication (для Btrfs)

1. **Панель управления > Snapshot Replication:**
   - Создать snapshot общей папки `git`
   - Настроить автоматическое создание снимков
   - Настроить репликацию на другой том/устройство

---

## Мониторинг и обслуживание

### Проверка статуса репозитория

```bash
# Проверка размера репозитория
du -sh /volume1/git/IP-CSS.git

# Проверка последней синхронизации
cd /volume1/git/IP-CSS.git
git log -1 --format="%ci %s"

# Проверка всех веток
git branch -a

# Проверка всех тегов
git tag -l

# Проверка целостности
git fsck --full
```

### Мониторинг синхронизации

```bash
# Просмотр логов синхронизации
tail -f /volume1/git/sync-ip-css.log

# Проверка статуса cron задач
sudo crontab -u gituser -l

# Проверка последнего выполнения задачи
grep "sync-ip-css" /var/log/synolog/synoscheduler.log
```

### Очистка репозитория

```bash
# Очистка неиспользуемых объектов
cd /volume1/git/IP-CSS.git
git gc --prune=now --aggressive

# Очистка старых reflog
git reflog expire --expire=now --all
git gc --prune=now
```

### Мониторинг дискового пространства

```bash
# Проверка использования диска
df -h /volume1

# Проверка размера всех репозиториев
du -sh /volume1/git/*

# Настройка уведомлений о нехватке места
# Панель управления > Уведомления > Настроить правила
```

---

## Устранение неполадок

### Проблема 1: Не удается клонировать репозиторий

**Решение:**
```bash
# Проверка прав доступа
ls -la /volume1/git/IP-CSS.git

# Проверка пользователя Git Server
sudo -u gituser git --version

# Проверка SSH подключения
ssh -v gituser@<IP_SYNOLOGY>
```

### Проблема 2: Синхронизация не работает

**Решение:**
```bash
# Проверка блокировки
ls -la /volume1/git/sync-ip-css.lock

# Ручной запуск синхронизации
sudo -u gituser /volume1/git/sync-ip-css.sh

# Проверка логов
cat /volume1/git/sync-ip-css.log
```

### Проблема 3: Недостаточно места на диске

**Решение:**
```bash
# Проверка использования диска
df -h

# Очистка старых резервных копий
# Удаление неиспользуемых репозиториев
# Настройка автоматической очистки через Hyper Backup
```

### Проблема 4: Медленная синхронизация

**Решение:**
- Проверить скорость сети
- Использовать SSH вместо HTTPS
- Настроить Git кэш
- Проверить нагрузку на систему

---

## Рекомендации по оптимизации

### Производительность

1. **Использование SSD кэша:**
   - Если доступен SSD кэш, разместить репозитории на кэшируемом томе

2. **Настройка Git:**
   ```bash
   git config --global pack.windowMemory "256m"
   git config --global pack.packSizeLimit "2g"
   git config --global pack.threads "4"
   ```

3. **Оптимизация файловой системы:**
   - Использовать Btrfs для лучшей производительности
   - Настроить автоматическую дефрагментацию

### Безопасность

1. **Регулярные обновления:**
   - Обновлять DSM регулярно
   - Обновлять Git Server пакет

2. **Мониторинг доступа:**
   - Включить логирование SSH доступа
   - Настроить уведомления о подозрительной активности

3. **Шифрование:**
   - Использовать SSH для всех операций
   - Настроить HTTPS с SSL сертификатом (если используется веб-доступ)

---

## Итоговая конфигурация

### Структура директорий

```
/volume1/
└── git/
    ├── IP-CSS.git/          # Bare репозиторий
    ├── sync-ip-css.sh       # Скрипт синхронизации
    ├── sync-ip-css.log      # Логи синхронизации
    └── sync-ip-css.lock     # Блокировка синхронизации
```

### Расписание синхронизации

- **Рекомендуется:** Каждые 6 часов или ежедневно в 3:00
- **Для активных проектов:** Каждый час
- **Для стабильных проектов:** Ежедневно

### Резервное копирование

- **Частота:** Ежедневно
- **Версионирование:** 30 дней
- **Место хранения:** Внешний диск или другой NAS

---

## Полезные команды

```bash
# Быстрая проверка статуса
cd /volume1/git/IP-CSS.git && git remote -v && git branch -a | head -5

# Принудительная синхронизация
cd /volume1/git/IP-CSS.git && git fetch --all --prune

# Проверка размера всех репозиториев
du -sh /volume1/git/*.git

# Просмотр последних коммитов
cd /volume1/git/IP-CSS.git && git log --oneline -10
```

---

**Последнее обновление:** Январь 2025
**Версия документа:** 1.0

