# Комплексный анализ инфраструктуры CI/CD и логирования

**Дата создания:** Январь 2025
**Версия проекта:** Alfa-0.0.1
**Последнее обновление:** Январь 2025

---

## Содержание

1. [Обзор](#обзор)
2. [Анализ Git зеркала на Synology RS2416+](#анализ-git-зеркала-на-synology-rs2416)
3. [Анализ Jenkins на Raspberry Pi](#анализ-jenkins-на-raspberry-pi)
4. [Анализ сервера логов на Raspberry Pi 4](#анализ-сервера-логов-на-raspberry-pi-4)
5. [Сравнительный анализ платформ](#сравнительный-анализ-платформ)
6. [Рекомендации по архитектуре инфраструктуры](#рекомендации-по-архитектуре-инфраструктуры)
7. [План внедрения](#план-внедрения)

---

## Обзор

Этот документ объединяет все исследования и анализы инфраструктуры для проекта IP-CSS, включая:

- **Git зеркало на Synology** - создание локальной копии репозитория для резервного копирования и быстрого доступа
- **Jenkins на Raspberry Pi** - настройка CI/CD pipeline на локальном оборудовании
- **Сервер логов на Raspberry Pi 4** - централизованный сбор, хранение и анализ логов

### Цели анализа

1. Оценить возможность использования локального оборудования для инфраструктуры
2. Определить оптимальные конфигурации для каждого компонента
3. Предоставить пошаговые инструкции по настройке
4. Выявить ограничения и риски
5. Предложить рекомендации по архитектуре

---

## Анализ Git зеркала на Synology RS2416+

**Дата анализа:** Январь 2025
**Целевое устройство:** Synology RS2416+ под управлением DSM 7.2

### Характеристики Synology RS2416+

#### Аппаратные характеристики

- **Процессор:** Intel Atom C2538 (x86_64, 4 ядра @ 2.4 GHz)
- **Память:** 2-16 ГБ DDR3 (рекомендуется минимум 4 ГБ)
- **Слоты:** 12x 3.5" SATA (поддержка hot-swap)
- **Сеть:** 4x Gigabit Ethernet (с возможностью агрегации)
- **Порты:** USB 3.0, eSATA
- **ОС:** DSM 7.2 (Linux-based, Debian)

#### Программные возможности

- **Git Server:** Встроенный пакет в Package Center
- **SSH доступ:** Полная поддержка
- **Docker:** Поддержка контейнеризации
- **Резервное копирование:** Hyper Backup, Snapshot Replication
- **Файловые системы:** Btrfs, ext4

### Установка Git Server на DSM 7.2

#### Способ 1: Через веб-интерфейс (рекомендуется)

1. **Открыть Package Center:**
   - Войдите в DSM веб-интерфейс
   - Откройте **Package Center** (Центр пакетов)

2. **Установка Git Server:**
   - Найдите пакет **"Git Server"**
   - Нажмите **"Установить"**
   - Дождитесь завершения установки

3. **Запуск службы:**
   - Откройте установленный **Git Server**
   - Включите службу
   - Настройте порт (по умолчанию: 22 для SSH, 9418 для Git протокола)

### Создание зеркала репозитория GitHub

#### Шаг 1: Подготовка директории

```bash
# Подключение к Synology через SSH
ssh admin@<IP_SYNOLOGY>

# Создание директории для репозиториев
sudo mkdir -p /volume1/git
sudo chmod 755 /volume1/git

# Создание пользователя для Git (если еще не создан)
# Через веб-интерфейс: Панель управления > Пользователь > Создать
# Или через SSH:
sudo synouser --add gituser <password> "" "" 0 "" 0
```

#### Шаг 2: Клонирование репозитория с зеркалированием

```bash
# Переключение на пользователя gituser
sudo su - gituser

# Переход в директорию репозиториев
cd /volume1/git

# Клонирование bare репозитория с зеркалированием
# Для публичного репозитория:
git clone --bare --mirror https://github.com/your-org/IP-CSS.git IP-CSS.git

# Для приватного репозитория (требуется SSH ключ):
git clone --bare --mirror git@github.com:your-org/IP-CSS.git IP-CSS.git

# Настройка зеркалирования
cd IP-CSS.git
git config remote.origin.fetch "+refs/*:refs/*"
git config remote.origin.mirror true
git config --bool core.bare true
```

### Настройка автоматической синхронизации

#### Скрипт синхронизации

```bash
#!/bin/bash
# Скрипт синхронизации зеркала репозитория IP-CSS

REPO_PATH="/volume1/git/IP-CSS.git"
LOG_FILE="/volume1/git/sync-ip-css.log"
LOCK_FILE="/volume1/git/sync-ip-css.lock"

# Проверка блокировки (предотвращение параллельных запусков)
if [ -f "$LOCK_FILE" ]; then
    echo "$(date): Sync already running, skipping..." >> "$LOG_FILE"
    exit 0
fi

# Создание блокировки
touch "$LOCK_FILE"

# Переход в директорию репозитория
cd "$REPO_PATH" || exit 1

# Синхронизация с GitHub
echo "$(date): Starting sync..." >> "$LOG_FILE"
git fetch --prune origin 2>&1 | tee -a "$LOG_FILE"

# Проверка результата
if [ $? -eq 0 ]; then
    echo "$(date): Sync completed successfully" >> "$LOG_FILE"
    git remote update --prune 2>&1 | tee -a "$LOG_FILE"
else
    echo "$(date): Sync failed!" >> "$LOG_FILE"
fi

# Удаление блокировки
rm -f "$LOCK_FILE"
```

#### Настройка cron задачи

```bash
# Права на выполнение
sudo chmod +x /volume1/git/sync-ip-css.sh
sudo chown gituser:users /volume1/git/sync-ip-css.sh

# Редактирование crontab для пользователя gituser
sudo crontab -u gituser -e

# Добавить строку (синхронизация каждые 6 часов):
0 */6 * * * /volume1/git/sync-ip-css.sh
```

### Настройка доступа и безопасности

#### SSH ключи

```bash
# На клиентской машине
ssh-keygen -t ed25519 -C "your_email@example.com"

# Копирование ключа на Synology
ssh-copy-id gituser@<IP_SYNOLOGY>
```

#### Firewall

1. **Панель управления > Безопасность > Брандмауэр:**
   - Разрешить порт 22 (SSH) для доверенных IP
   - Разрешить порт 9418 (Git протокол) при необходимости
   - Ограничить доступ по IP адресам

### Резервное копирование

#### Hyper Backup (встроенный инструмент DSM)

1. **Открыть Hyper Backup:**
   - Package Center > Hyper Backup

2. **Создать задачу резервного копирования:**
   - **Тип:** Локальная папка и USB
   - **Источник:** Выбрать `/volume1/git`
   - **Назначение:** Выбрать место для резервных копий
   - **Расписание:** Настроить (например, ежедневно в 2:00)

3. **Настройка версионирования:**
   - Включить версионирование
   - Настроить количество версий (например, 30 дней)

### Мониторинг и обслуживание

#### Проверка статуса репозитория

```bash
# Проверка размера репозитория
du -sh /volume1/git/IP-CSS.git

# Проверка последней синхронизации
cd /volume1/git/IP-CSS.git
git log -1 --format="%ci %s"

# Проверка всех веток
git branch -a

# Проверка целостности
git fsck --full
```

#### Очистка репозитория

```bash
# Очистка неиспользуемых объектов
cd /volume1/git/IP-CSS.git
git gc --prune=now --aggressive

# Очистка старых reflog
git reflog expire --expire=now --all
git gc --prune=now
```

### Итоговая конфигурация

**Структура директорий:**
```
/volume1/
└── git/
    ├── IP-CSS.git/          # Bare репозиторий
    ├── sync-ip-css.sh       # Скрипт синхронизации
    ├── sync-ip-css.log      # Логи синхронизации
    └── sync-ip-css.lock     # Блокировка синхронизации
```

**Расписание синхронизации:**
- **Рекомендуется:** Каждые 6 часов или ежедневно в 3:00
- **Для активных проектов:** Каждый час
- **Для стабильных проектов:** Ежедневно

---

## Анализ Jenkins на Raspberry Pi

**Дата анализа:** Январь 2025
**Целевые устройства:** Raspberry Pi 4 и Raspberry Pi 5

### Raspberry Pi 4: Jenkins + Blue Ocean

#### Аппаратные характеристики

- **Модель:** Raspberry Pi 4 Model B
- **Процессор:** Broadcom BCM2711, Quad-core Cortex-A72 @ 1.8 GHz
- **Память:** 4 ГБ LPDDR4-3200
- **Хранилище:** M.2 SSD 256 ГБ (через USB 3.0 адаптер)
- **Сеть:** Gigabit Ethernet, Wi-Fi 802.11ac, Bluetooth 5.0
- **Порты:** 2x USB 3.0, 2x USB 2.0, 2x micro-HDMI
- **ОС:** Raspberry Pi OS x64 (Debian-based)

#### Критические ограничения

**Проблема с памятью:**

**Текущая конфигурация проекта:**
- `gradle.properties`: `org.gradle.jvmargs=-Xmx4096m` (4 ГБ) ❌
- Это **недопустимо** для системы с 4 ГБ RAM

**Распределение памяти (4 ГБ):**
- Система (Raspberry Pi OS): ~500 МБ
- Jenkins JVM: ~512 МБ
- Gradle JVM: **максимум 1536 МБ** (не 4096 МБ!)
- Node.js/npm: ~256 МБ
- Резерв для системы: ~700 МБ
- **Итого доступно для сборки: ~1.5 ГБ**

#### Установка и настройка

##### Шаг 1: Подготовка системы

```bash
# Обновление системы
sudo apt update && sudo apt upgrade -y

# Отключение ненужных сервисов для освобождения памяти
sudo systemctl disable bluetooth
sudo systemctl disable avahi-daemon
sudo systemctl disable cups

# Настройка swap (критически важно!)
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# Изменить: CONF_SWAPSIZE=2048 (2 ГБ)
sudo dphys-swapfile setup
sudo dphys-swapfile swapon
```

##### Шаг 2: Установка Java 17

```bash
# Установка OpenJDK 17
sudo apt install openjdk-17-jdk -y

# Проверка версии
java -version
javac -version

# Настройка JAVA_HOME
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-arm64' >> ~/.bashrc
source ~/.bashrc
```

##### Шаг 3: Установка Jenkins

```bash
# Добавление репозитория Jenkins
curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | sudo tee \
  /usr/share/keyrings/jenkins-keyring.asc > /dev/null
echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null

# Установка Jenkins
sudo apt update
sudo apt install jenkins -y

# Настройка Jenkins для ограниченной памяти
sudo nano /etc/default/jenkins
```

**Критически важные настройки Jenkins:**

```bash
JENKINS_JAVA_OPTIONS="-Xmx512m -Xms128m -XX:MaxMetaspaceSize=256m -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.awt.headless=true"
JENKINS_USER=jenkins
JENKINS_HOME=/var/lib/jenkins
JENKINS_PORT=8080
JENKINS_LISTEN_ADDRESS=0.0.0.0
```

```bash
# Запуск Jenkins
sudo systemctl start jenkins
sudo systemctl enable jenkins
sudo systemctl status jenkins

# Получение начального пароля
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
```

##### Шаг 4: Оптимизация Gradle для Pi 4

**Создание оптимизированного gradle.properties:**

```properties
# Оптимизированные настройки для Raspberry Pi 4 (4 ГБ RAM)
org.gradle.jvmargs=-Xmx1536m -Xms256m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.configureondemand=true
org.gradle.daemon=true
org.gradle.workers.max=2

# Kotlin
kotlin.code.style=official
kotlin.incremental=true
kotlin.native.cacheKind=static
kotlin.native.ignoreDisabledTargets=true
kotlin.mpp.applyDefaultHierarchyTemplate=false

# Android
android.useAndroidX=true
android.enableJetifier=true
android.defaults.buildfeatures.buildconfig=true
android.nonTransitiveRClass=false
android.nonFinalResIds=false
android.overridePathCheck=true

# Compose
compose.kotlinCompilerExtensionVersion=1.5.3

# Version
version=Alfa-0.0.1
group=com.company.ipcamera
```

#### Ограничения и возможности Pi 4

##### ✅ Что можно собирать:

- Core модули (common, network)
- Shared модуль
- Server API
- Web интерфейс (с ограничениями)
- Простые native библиотеки (без OpenCV/TensorFlow)

##### ⚠️ Ограничения:

- Native библиотеки с OpenCV/TensorFlow (слишком ресурсоемко)
- Android сборки (требуют много памяти)
- Параллельные сборки (максимум 2 workers)
- Время сборки: 1-2 часа для полной сборки

##### ❌ Не рекомендуется:

- Собирать Android на Pi 4
- Собирать native библиотеки с AI/ML
- Параллельные сборки нескольких проектов
- Запуск других тяжелых сервисов одновременно

### Raspberry Pi 5: Jenkins + Blue Ocean (максимальная конфигурация)

#### Аппаратные характеристики (максимальная конфигурация)

- **Модель:** Raspberry Pi 5 Model B
- **Процессор:** Broadcom BCM2712, Quad-core Cortex-A76 @ 2.4 GHz (до 3.0 GHz с разгоном)
- **Память:** **8 ГБ LPDDR4X-4267** (максимальная конфигурация)
- **Хранилище:** M.2 SSD 256+ ГБ (через PCIe 2.0 x1, до 500 МБ/с)
- **Сеть:** Gigabit Ethernet, Wi-Fi 6 (802.11ax), Bluetooth 5.0
- **Порты:** 2x USB 3.0, 2x USB 2.0, 2x micro-HDMI, PCIe 2.0 x1
- **Графика:** VideoCore VII GPU
- **ОС:** Raspberry Pi OS x64 (Debian-based)

#### Преимущества Raspberry Pi 5

##### Производительность

- **CPU:** ~2x быстрее Pi 4 (Cortex-A76 vs A72)
- **Память:** 8 ГБ vs 4 ГБ (в 2 раза больше)
- **Хранилище:** PCIe 2.0 x1 (до 500 МБ/с) vs USB 3.0 (~400 МБ/с)
- **GPU:** VideoCore VII (улучшенная производительность)

##### Возможности для сборки

- **Gradle JVM:** До 4-5 ГБ (vs 1.5 ГБ на Pi 4)
- **Параллельные сборки:** До 4-6 workers (vs 2 на Pi 4)
- **Время сборки:** ~30-60 минут (vs 1-2 часа на Pi 4)
- **Поддержка:** Native библиотеки с OpenCV (ограниченно)

#### Оптимизация Gradle для Pi 5

**Создание оптимизированного gradle.properties:**

```properties
# Оптимизированные настройки для Raspberry Pi 5 (8 ГБ RAM)
org.gradle.jvmargs=-Xmx4096m -Xms512m -XX:MaxMetaspaceSize=1024m -XX:+UseG1GC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.configureondemand=true
org.gradle.daemon=true
org.gradle.workers.max=4

# Kotlin
kotlin.code.style=official
kotlin.incremental=true
kotlin.native.cacheKind=static
kotlin.native.ignoreDisabledTargets=true
kotlin.mpp.applyDefaultHierarchyTemplate=false

# Android
android.useAndroidX=true
android.enableJetifier=true
android.defaults.buildfeatures.buildconfig=true
android.nonTransitiveRClass=false
android.nonFinalResIds=false
android.overridePathCheck=true

# Compose
compose.kotlinCompilerExtensionVersion=1.5.3

# Version
version=Alfa-0.0.1
group=com.company.ipcamera
```

#### Возможности Pi 5

##### ✅ Что можно собирать:

- Все модули проекта (core, shared, server)
- Web интерфейс (без ограничений)
- Native библиотеки с OpenCV (ограниченно)
- Параллельные сборки модулей
- Android сборки (базовые, без полного тестирования)

##### ⚠️ Ограничения:

- Native библиотеки с TensorFlow (все еще ресурсоемко)
- Полные Android сборки с тестами (медленно)
- Одновременные сборки нескольких больших проектов

##### ✅ Преимущества:

- Время сборки: 30-60 минут (vs 1-2 часа на Pi 4)
- Параллельные сборки: до 4-6 workers
- Поддержка более сложных native библиотек
- Лучшая производительность при сборке web интерфейса

### Сравнительный анализ Raspberry Pi 4 и Pi 5

| Параметр | Raspberry Pi 4 (4 ГБ) | Raspberry Pi 5 (8 ГБ) |
|----------|----------------------|----------------------|
| **CPU** | Cortex-A72 @ 1.8 GHz | Cortex-A76 @ 2.4-3.0 GHz |
| **RAM** | 4 ГБ | 8 ГБ |
| **Хранилище** | USB 3.0 M.2 (~400 МБ/с) | PCIe 2.0 M.2 (~500 МБ/с) |
| **Jenkins JVM** | 512 МБ | 1024 МБ |
| **Gradle JVM** | 1536 МБ | 4096 МБ |
| **Gradle Workers** | 2 | 4-6 |
| **Node.js Memory** | 1024 МБ | 2048 МБ |
| **Время сборки** | 1-2 часа | 30-60 минут |
| **Параллельные сборки** | Очень ограничено | Поддерживается |
| **Native + OpenCV** | ❌ Нет | ⚠️ Ограниченно |
| **Android сборки** | ❌ Нет | ⚠️ Базовые |
| **Стоимость** | ~$75 | ~$80-100 |

### Рекомендации по выбору платформы

#### Выбор Raspberry Pi 4 (4 ГБ)

**Подходит для:**
- ✅ Базовые сборки (core, shared, server API)
- ✅ Web интерфейс (с ограничениями)
- ✅ Небольшие проекты
- ✅ Ограниченный бюджет
- ✅ Простые CI/CD задачи

**Не подходит для:**
- ❌ Сложные native библиотеки
- ❌ Android сборки
- ❌ Параллельные сборки
- ❌ Быстрые сборки

#### Выбор Raspberry Pi 5 (8 ГБ)

**Подходит для:**
- ✅ Все модули проекта
- ✅ Параллельные сборки
- ✅ Native библиотеки (ограниченно)
- ✅ Более быстрые сборки
- ✅ Более сложные CI/CD задачи

**Не подходит для:**
- ❌ Полные Android сборки с тестами
- ❌ TensorFlow native библиотеки
- ❌ Профессиональные CI/CD (лучше использовать сервер)

---

## Анализ сервера логов на Raspberry Pi 4

**Дата анализа:** Январь 2025
**Целевая платформа:** Raspberry Pi 4 (4GB RAM) с Raspberry OS Full x64

### Цель анализа

Провести комплексный анализ возможности создания централизованного сервера сбора, хранения и анализа логов для системы IP-CSS на базе Raspberry Pi 4 с 4GB оперативной памяти под управлением Raspberry OS Full x64.

### Технические характеристики Raspberry Pi 4

| Параметр | Значение |
|----------|----------|
| **Процессор** | Broadcom BCM2711, Quad-core Cortex-A72 (ARMv8) 64-bit @ 1.8GHz |
| **Память** | 4GB LPDDR4-3200 SDRAM |
| **Хранилище** | MicroSD (рекомендуется 64GB+ Class 10) или USB SSD |
| **Сеть** | Gigabit Ethernet, Wi-Fi 5 (802.11ac), Bluetooth 5.0 |
| **USB** | 2x USB 3.0, 2x USB 2.0 |
| **Видео** | VideoCore VI GPU (не используется для логирования) |
| **Питание** | 5V/3A через USB-C |

### Преимущества и ограничения

#### ✅ Преимущества

1. **Низкое энергопотребление**
   - ~5-7W в режиме простоя
   - ~10-15W под нагрузкой
   - Идеально для 24/7 работы

2. **Достаточная производительность для логирования**
   - 4 ядра ARM Cortex-A72 достаточно для обработки логов
   - 4GB RAM позволяет запускать легковесные стеки

3. **Низкая стоимость**
   - Raspberry Pi 4 4GB: ~$55-75
   - Минимальные затраты на инфраструктуру

4. **Компактность**
   - Размеры: 88mm x 58mm x 19.5mm
   - Легко разместить в любом месте

#### ⚠️ Ограничения

1. **Ограниченная память (4GB)**
   - Не подходит для тяжелых стеков (полный ELK)
   - Требуется оптимизация и выбор легковесных решений

2. **Производительность CPU**
   - ARM архитектура медленнее x86-64
   - Ограниченная пропускная способность для индексации

3. **I/O производительность**
   - MicroSD карты имеют ограниченную скорость записи
   - Рекомендуется USB SSD для лучшей производительности

### Сравнение технологий

#### Вариант 1: ELK Stack (Elasticsearch, Logstash, Kibana)

**Плюсы:**
- ✅ Полнофункциональное решение
- ✅ Мощные возможности поиска и анализа
- ✅ Богатая экосистема плагинов

**Минусы:**
- ❌ **Очень тяжелый для Raspberry Pi 4**
  - Elasticsearch требует минимум 2GB RAM только для себя
  - Logstash: ~500MB-1GB RAM
  - Kibana: ~500MB RAM
  - **Итого: ~3-4GB RAM** - не поместится в 4GB Pi

**Вердикт:** ❌ **НЕ РЕКОМЕНДУЕТСЯ** для Raspberry Pi 4 4GB

#### Вариант 2: Loki + Promtail + Grafana (РЕКОМЕНДУЕТСЯ)

**Плюсы:**
- ✅ **Легковесный стек**
  - Loki: ~200-500MB RAM
  - Promtail: ~50-100MB RAM
  - Grafana: ~100-200MB RAM
  - **Итого: ~400-800MB RAM** - отлично для Pi
- ✅ Оптимизирован для хранения логов (не индексирует содержимое)
- ✅ Интеграция с Prometheus для метрик
- ✅ Хорошая производительность на ARM
- ✅ Простая установка через Docker

**Минусы:**
- ⚠️ Меньше возможностей поиска по сравнению с ELK
- ⚠️ Требует настройки меток (labels) для эффективного поиска

**Вердикт:** ✅ **РЕКОМЕНДУЕТСЯ** как основной вариант

### Рекомендуемая архитектура: Loki + Promtail + Grafana

#### Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                    IP-CSS Компоненты                        │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ REST API     │  │ Web UI       │  │ Android/iOS  │     │
│  │ (Ktor)       │  │ (Next.js)    │  │ Clients     │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                            │                                 │
│                   ┌────────▼────────┐                       │
│                   │  Log Files /    │                       │
│                   │  Syslog / HTTP  │                       │
│                   └────────┬────────┘                       │
└────────────────────────────┼────────────────────────────────┘
                             │
                             │ (logs)
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              Raspberry Pi 4 - Log Server                    │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐ │
│  │              Promtail (Log Collector)                │ │
│  │  RAM: ~50-100MB                                       │ │
│  └───────────────────┬──────────────────────────────────┘ │
│                      │                                      │
│                      │ (HTTP/gRPC)                          │
│                      ▼                                      │
│  ┌──────────────────────────────────────────────────────┐ │
│  │              Loki (Log Storage)                       │ │
│  │  RAM: ~200-500MB                                      │ │
│  │  Disk: ~200GB-1TB (зависит от retention)            │ │
│  └───────────────────┬──────────────────────────────────┘ │
│                      │                                      │
│                      │ (queries)                            │
│                      ▼                                      │
│  ┌──────────────────────────────────────────────────────┐ │
│  │              Grafana (Visualization)                 │ │
│  │  RAM: ~100-200MB                                      │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐ │
│  │              Prometheus (Metrics)                    │ │
│  │  RAM: ~50-100MB                                      │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                              │
│  Итого RAM: ~400-900MB (в пределах 4GB)                    │
└─────────────────────────────────────────────────────────────┘
```

### Оценка производительности

#### Пропускная способность

**Теоретическая производительность Loki на Raspberry Pi 4:**

| Метрика | Значение |
|---------|----------|
| **Максимальная скорость приема** | 5,000-10,000 логов/сек |
| **Средняя скорость приема** | 2,000-5,000 логов/сек |
| **Задержка индексации** | 1-3 секунды |
| **Время поиска (типичный запрос)** | 0.5-2 секунды |
| **Время поиска (сложный запрос)** | 2-5 секунд |

#### Использование ресурсов

**Типичная нагрузка (2,000 логов/сек):**

| Компонент | RAM | CPU | Disk I/O |
|-----------|-----|-----|---------|
| Promtail | 50MB | 5% | Низкое |
| Loki | 300MB | 25% | Среднее |
| Grafana | 150MB | 10% | Низкое |
| Prometheus | 80MB | 5% | Низкое |
| Система (OS) | 500MB | 10% | - |
| **Итого** | **~1,080MB** | **~55%** | Среднее |

**Пиковая нагрузка (10,000 логов/сек):**

| Компонент | RAM | CPU | Disk I/O |
|-----------|-----|-----|---------|
| Promtail | 100MB | 15% | Среднее |
| Loki | 500MB | 60% | Высокое |
| Grafana | 200MB | 15% | Низкое |
| Prometheus | 100MB | 10% | Низкое |
| Система (OS) | 500MB | 15% | - |
| **Итого** | **~1,400MB** | **~115%** (перегрузка) | Высокое |

### Расчет дискового пространства

**Предположения:**
- Средний размер лога: 500 байт
- Объем логов: 5,000 логов/сек в среднем
- Retention: 30 дней

**Расчет:**
```
Средний объем в день:
5,000 логов/сек × 86,400 сек/день × 500 байт = 216 GB/день

С учетом сжатия (gzip, ~10:1):
216 GB / 10 = 21.6 GB/день

За 30 дней:
21.6 GB × 30 = 648 GB

С учетом индексов и метаданных (+30%):
648 GB × 1.3 = 842 GB
```

**Вывод:** Требуется минимум 1TB дискового пространства для 30 дней хранения при указанной нагрузке.

### План реализации

#### Этап 1: Подготовка Raspberry Pi 4

**Время:** 1-2 часа

1. **Установка Raspberry OS Full x64**
2. **Базовая настройка системы**
3. **Установка Docker**
4. **Оптимизация для логирования**

#### Этап 2: Развертывание Loki Stack

**Время:** 2-3 часа

1. **Создание структуры директорий**
2. **Создание docker-compose.yml**
3. **Конфигурация Loki**
4. **Конфигурация Promtail**
5. **Запуск стека**

#### Этап 3: Интеграция с IP-CSS

**Время:** 3-4 часа

1. **Настройка логирования в IP-CSS**
2. **Настройка отправки логов через HTTP (опционально)**
3. **Создание дашбордов в Grafana**

#### Этап 4: Настройка алертинга

**Время:** 1-2 часа

1. **Создание правил алертинга в Grafana**
2. **Настройка уведомлений**

### Риски и ограничения

#### Технические риски

1. **Переполнение диска**
   - **Риск:** Высокий при недостаточном мониторинге
   - **Митигация:** Автоматическая очистка старых логов, мониторинг свободного места

2. **Перегрузка CPU при пиковых нагрузках**
   - **Риск:** Средний
   - **Митигация:** Rate limiting на стороне Loki, буферизация на стороне клиентов

3. **Недостаток памяти**
   - **Риск:** Низкий при правильной настройке
   - **Митигация:** Мониторинг использования памяти, настройка лимитов для контейнеров

---

## Сравнительный анализ платформ

### Сводная таблица платформ

| Платформа | Назначение | CPU | RAM | Хранилище | Стоимость | Энергопотребление |
|-----------|-----------|-----|-----|-----------|-----------|-------------------|
| **Synology RS2416+** | Git зеркало, NAS | Intel Atom C2538 (4 ядра @ 2.4 GHz) | 2-16 ГБ | 12x SATA | ~$800-1200 | ~30-50W |
| **Raspberry Pi 4** | Jenkins CI/CD, Log Server | Cortex-A72 (4 ядра @ 1.8 GHz) | 4 ГБ | USB SSD/MicroSD | ~$75 | ~5-15W |
| **Raspberry Pi 5** | Jenkins CI/CD (улучшенный) | Cortex-A76 (4 ядра @ 2.4-3.0 GHz) | 8 ГБ | PCIe M.2 | ~$80-100 | ~5-20W |

### Рекомендации по использованию

#### Synology RS2416+

**Использование:**
- ✅ Git зеркало для резервного копирования
- ✅ Централизованное хранилище
- ✅ Резервное копирование через Hyper Backup
- ✅ Долгосрочное хранение данных

**Не использовать для:**
- ❌ CI/CD сборки (недостаточно производительности)
- ❌ Обработка логов (не оптимизировано)

#### Raspberry Pi 4

**Использование:**
- ✅ Легковесный CI/CD для базовых сборок
- ✅ Сервер логов (Loki stack)
- ✅ Простые задачи автоматизации

**Не использовать для:**
- ❌ Сложные сборки (Android, native с ML)
- ❌ Высоконагруженные сервисы

#### Raspberry Pi 5

**Использование:**
- ✅ Полноценный CI/CD для большинства задач
- ✅ Параллельные сборки
- ✅ Native библиотеки (ограниченно)

**Не использовать для:**
- ❌ Профессиональные CI/CD (лучше сервер)
- ❌ TensorFlow native библиотеки

---

## Рекомендации по архитектуре инфраструктуры

### Рекомендуемая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub (Основной репозиторий)            │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ (синхронизация)
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Synology RS2416+ (Git Mirror)                  │
│  - Git зеркало для резервного копирования                  │
│  - Локальный доступ к репозиторию                          │
│  - Синхронизация каждые 6 часов                            │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ (клонирование)
                        ▼
┌─────────────────────────────────────────────────────────────┐
│         Raspberry Pi 5 (Jenkins CI/CD)                      │
│  - Jenkins + Blue Ocean                                     │
│  - Gradle сборки (4 ГБ JVM, 4 workers)                    │
│  - Время сборки: 30-60 минут                               │
│  - Поддержка параллельных сборок                           │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ (логи)
                        ▼
┌─────────────────────────────────────────────────────────────┐
│      Raspberry Pi 4 (Log Server)                           │
│  - Loki + Promtail + Grafana                               │
│  - Сбор логов со всех компонентов                          │
│  - Хранение 30 дней                                        │
│  - Визуализация и алертинг                                 │
└─────────────────────────────────────────────────────────────┘
```

### Преимущества такой архитектуры

1. **Разделение ответственности**
   - Каждое устройство выполняет свою специализированную задачу
   - Оптимизация под конкретные требования

2. **Масштабируемость**
   - Легко добавить дополнительные Pi для распределения нагрузки
   - Возможность миграции на более мощное оборудование

3. **Надежность**
   - Git зеркало обеспечивает резервное копирование
   - Логирование позволяет отслеживать проблемы

4. **Экономичность**
   - Использование доступного оборудования
   - Низкое энергопотребление

### Альтернативные архитектуры

#### Вариант 1: Все на одном устройстве

**Использование:** Raspberry Pi 5 для всего

**Плюсы:**
- Меньше устройств
- Проще управление

**Минусы:**
- Перегрузка ресурсов
- Медленнее сборки
- Риск переполнения диска

#### Вариант 2: Облачная инфраструктура

**Использование:** GitHub Actions, Grafana Cloud

**Плюсы:**
- Высокая производительность
- Автоматическое масштабирование
- Профессиональная поддержка

**Минусы:**
- Постоянные затраты
- Зависимость от интернета
- Проблемы с конфиденциальностью

---

## План внедрения

### Фаза 1: Git зеркало (1-2 дня)

**Приоритет:** Высокий

1. Настройка Synology RS2416+
2. Установка Git Server
3. Создание зеркала репозитория
4. Настройка автоматической синхронизации
5. Тестирование доступа

**Результат:** Работающее Git зеркало с автоматической синхронизацией

### Фаза 2: Jenkins CI/CD (3-5 дней)

**Приоритет:** Высокий

1. Подготовка Raspberry Pi 5
2. Установка Java 17 и Jenkins
3. Настройка оптимизированного Gradle
4. Создание Jenkinsfile
5. Настройка Blue Ocean
6. Тестирование сборок

**Результат:** Работающий CI/CD pipeline

### Фаза 3: Сервер логов (2-3 дня)

**Приоритет:** Средний

1. Подготовка Raspberry Pi 4
2. Развертывание Loki stack
3. Интеграция с IP-CSS
4. Создание дашбордов
5. Настройка алертинга

**Результат:** Централизованный сбор и анализ логов

### Фаза 4: Оптимизация и мониторинг (1-2 недели)

**Приоритет:** Средний

1. Мониторинг производительности
2. Оптимизация конфигураций
3. Настройка резервного копирования
4. Документирование процедур

**Результат:** Оптимизированная и документированная инфраструктура

---

## Выводы

### Общие выводы

1. **Локальная инфраструктура возможна**
   - Все компоненты могут работать на доступном оборудовании
   - Требуется правильная настройка и оптимизация

2. **Raspberry Pi подходит для большинства задач**
   - Pi 4: базовые задачи (логирование, простые сборки)
   - Pi 5: полноценный CI/CD для большинства проектов

3. **Synology отлично подходит для Git зеркала**
   - Встроенный Git Server
   - Надежное хранилище
   - Простое управление

4. **Требуется оптимизация**
   - Правильное распределение памяти
   - Оптимизация Gradle для ограниченных ресурсов
   - Мониторинг использования ресурсов

### Ключевые рекомендации

1. **Использовать специализированные устройства**
   - Synology для Git зеркала
   - Pi 5 для CI/CD
   - Pi 4 для логирования

2. **Оптимизировать конфигурации**
   - Правильные настройки памяти для Gradle
   - Использование SSD вместо MicroSD
   - Настройка swap/zram

3. **Мониторить ресурсы**
   - Настройка алертов на перегрузку
   - Регулярная проверка использования диска
   - Мониторинг температуры

4. **Планировать масштабирование**
   - Возможность миграции на более мощное оборудование
   - Горизонтальное масштабирование при необходимости

---

## Приложения

### Приложение A: Полезные команды

#### Git зеркало

```bash
# Быстрая проверка статуса
cd /volume1/git/IP-CSS.git && git remote -v && git branch -a | head -5

# Принудительная синхронизация
cd /volume1/git/IP-CSS.git && git fetch --all --prune

# Проверка размера всех репозиториев
du -sh /volume1/git/*.git
```

#### Jenkins

```bash
# Проверка статуса Jenkins
sudo systemctl status jenkins

# Просмотр логов
sudo journalctl -u jenkins -f

# Остановка/запуск
sudo systemctl stop jenkins
sudo systemctl start jenkins
```

#### Loki Stack

```bash
# Проверка статуса контейнеров
docker-compose ps

# Просмотр логов
docker-compose logs -f loki

# Перезапуск стека
docker-compose restart
```

### Приложение B: Конфигурационные файлы

Все конфигурационные файлы доступны в соответствующих разделах документа.

### Приложение C: Ссылки на документацию

- [RASPBERRY_PI_JENKINS_ANALYSIS.md](RASPBERRY_PI_JENKINS_ANALYSIS.md) - Детальный анализ Jenkins
- [SYNOLOGY_GIT_MIRROR_ANALYSIS.md](SYNOLOGY_GIT_MIRROR_ANALYSIS.md) - Детальный анализ Git зеркала
- [../Log-server/RASPBERRY_PI_4_ANALYSIS.md](../Log-server/RASPBERRY_PI_4_ANALYSIS.md) - Детальный анализ сервера логов

---

**Последнее обновление:** Январь 2025
**Версия документа:** 1.0
**Автор:** AI Assistant

